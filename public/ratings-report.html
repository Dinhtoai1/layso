<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>B√°o c√°o ƒë√°nh gi√° m·ª©c ƒë·ªô h√†i l√≤ng</title>
  <style>
  body { 
    font-family: Arial, sans-serif; 
    background: #f8f8f8; 
    margin: 0; 
    padding: 20px; 
  }
  .container { 
    max-width: 1200px; 
    margin: 0 auto; 
    background: white; 
    padding: 30px; 
    border-radius: 12px; 
    box-shadow: 0 4px 24px rgba(0,0,0,0.1);
  }
  h1 { 
    text-align: center; 
    color: #1976d2; 
    margin-bottom: 30px;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .stat-card {
    background: linear-gradient(135deg, #1976d2, #42a5f5);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
  }
  .stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 16px;
    opacity: 0.9;
  }
  .stat-value {
    font-size: 32px;
    font-weight: bold;
    margin: 0;
  }
  .star-display {
    font-size: 24px;
    color: #ffc107;
    margin-top: 5px;
  }
  .controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }
  .refresh-btn {
    background: #4caf50;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  .refresh-btn:hover {
    background: #45a049;
  }
  .back-btn {
    background: #757575;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  .back-btn:hover {
    background: #616161;
  }
  .filter-section {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .filter-section select {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  .ratings-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  .ratings-table th,
  .ratings-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }
  .ratings-table th {
    background: #f5f5f5;
    font-weight: bold;
    color: #333;
  }
  .ratings-table tr:hover {
    background: #f9f9f9;
  }
  .rating-stars {
    color: #ffc107;
    font-size: 16px;
  }
  .comment-cell {
    max-width: 300px;
    word-wrap: break-word;
  }
  .no-data {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
  }
  .service-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }
  .service-stat-card {
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
  }
  .service-stat-card h4 {
    margin: 0 0 10px 0;
    color: #1976d2;
    font-size: 14px;
  }
  .service-stat-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    font-size: 12px;
  }
  .service-stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .service-stat-stars {
    color: #ffc107;
    font-size: 12px;
  }
  .loading {
    text-align: center;
    padding: 40px;
    color: #666;
  }
  @media (max-width: 768px) {
    .container {
      margin: 10px;
      padding: 20px;
    }
    .stats-grid {
      grid-template-columns: 1fr;
    }
    .controls {
      flex-direction: column;
      align-items: stretch;
    }
    .filter-section {
      justify-content: center;
    }
    .ratings-table {
      font-size: 14px;
    }
    .ratings-table th,
    .ratings-table td {
      padding: 8px 4px;
    }
    .comment-cell {
      max-width: 150px;
    }
  }
  </style>
</head>
<body>
  <div class="container">
    <h1>B√°o c√°o ƒë√°nh gi√° m·ª©c ƒë·ªô h√†i l√≤ng</h1>
    
    <div class="controls">
      <button class="back-btn" onclick="goBack()">Quay l·∫°i</button>
      <div class="filter-section">
        <select id="sortOrder">
          <option value="newest">M·ªõi nh·∫•t</option>
          <option value="oldest">C≈© nh·∫•t</option>
          <option value="highest">ƒêi·ªÉm cao nh·∫•t</option>
          <option value="lowest">ƒêi·ªÉm th·∫•p nh·∫•t</option>
        </select>
      </div>
      <button class="refresh-btn" onclick="loadRatingsReport()">L√†m m·ªõi</button>
      <button class="refresh-btn" onclick="exportToExcel()" style="background: #ff9800;">üì• Xu·∫•t Excel</button>
      <button class="back-btn" onclick="goBack()">Quay l·∫°i</button>
    </div>

    <div id="loadingMessage" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    
    <div id="reportContent" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <h3>T·ªïng s·ªë ƒë√°nh gi√°</h3>
          <p class="stat-value" id="totalRatings">0</p>
        </div>
        <div class="stat-card">
          <h3>Ch·∫•t l∆∞·ª£ng ph·ª•c v·ª•</h3>
          <p class="stat-value" id="avgService">0</p>
          <div class="star-display" id="starsService"></div>
        </div>
        <div class="stat-card">
          <h3>Th·ªùi gian x·ª≠ l√Ω</h3>
          <p class="stat-value" id="avgTime">0</p>
          <div class="star-display" id="starsTime"></div>
        </div>
        <div class="stat-card">
          <h3>Th√°i ƒë·ªô nh√¢n vi√™n</h3>
          <p class="stat-value" id="avgAttitude">0</p>
          <div class="star-display" id="starsAttitude"></div>
        </div>
        <div class="stat-card">
          <h3>ƒê√°nh gi√° t·ªïng th·ªÉ</h3>
          <p class="stat-value" id="avgOverall">0</p>
          <div class="star-display" id="starsOverall"></div>
        </div>
      </div>

      <!-- Th·ªëng k√™ theo lƒ©nh v·ª±c -->
      <h3 style="margin-top: 30px; margin-bottom: 20px; color: #1976d2;">Th·ªëng k√™ theo lƒ©nh v·ª±c d·ªãch v·ª•</h3>
      <div id="serviceStatsContainer"></div>

      <h3 style="margin-top: 30px; margin-bottom: 20px; color: #1976d2;">Chi ti·∫øt ƒë√°nh gi√°</h3>
      <table class="ratings-table">
        <thead>
          <tr>
            <th>Th·ªùi gian</th>
            <th>Lƒ©nh v·ª±c</th>
            <th>Ph·ª•c v·ª•</th>
            <th>Th·ªùi gian</th>
            <th>Th√°i ƒë·ªô</th>
            <th>T·ªïng th·ªÉ</th>
            <th>√ù ki·∫øn</th>
          </tr>
        </thead>
        <tbody id="ratingsTableBody">
        </tbody>
      </table>
    </div>

    <div id="noDataMessage" class="no-data" style="display: none;">
      Ch∆∞a c√≥ ƒë√°nh gi√° n√†o ƒë∆∞·ª£c ghi nh·∫≠n.
    </div>
  </div>

  <script>
    let ratingsData = [];

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function createStars(rating) {
      const fullStars = Math.floor(rating);
      const hasHalfStar = (rating - fullStars) >= 0.5;
      let stars = '';
      
      for (let i = 0; i < fullStars; i++) {
        stars += '‚òÖ';
      }
      if (hasHalfStar) {
        stars += '‚òÜ';
      }
      const remainingStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
      for (let i = 0; i < remainingStars; i++) {
        stars += '‚òÜ';
      }
      
      return stars;
    }

    function updateStatistics(data) {
      document.getElementById('totalRatings').textContent = data.totalRatings;
      
      if (data.totalRatings > 0) {
        // X·ª≠ l√Ω averages - c√≥ th·ªÉ null n·∫øu kh√¥ng c√≥ format c≈©
        const averages = data.averages || { serviceRating: 0, time: 0, attitude: 0, overall: 0 };
        
        document.getElementById('avgService').textContent = averages.serviceRating || '0.00';
        document.getElementById('avgTime').textContent = averages.time || '0.00';
        document.getElementById('avgAttitude').textContent = averages.attitude || '0.00';
        document.getElementById('avgOverall').textContent = averages.overall || '0.00';
        
        document.getElementById('starsService').textContent = createStars(parseFloat(averages.serviceRating || 0));
        document.getElementById('starsTime').textContent = createStars(parseFloat(averages.time || 0));
        document.getElementById('starsAttitude').textContent = createStars(parseFloat(averages.attitude || 0));
        document.getElementById('starsOverall').textContent = createStars(parseFloat(averages.overall || 0));
        
        // Hi·ªÉn th·ªã th√¥ng tin format m·ªõi n·∫øu c√≥
        if (data.newFormatAverage && data.newFormatCount > 0) {
          const newFormatInfo = document.createElement('div');
          newFormatInfo.style.cssText = 'margin-top: 10px; padding: 10px; background: #e8f5e8; border-radius: 5px; font-size: 12px;';
          newFormatInfo.innerHTML = `
            <strong>üìä Th·ªëng k√™ format m·ªõi:</strong><br>
            S·ªë ƒë√°nh gi√°: ${data.newFormatCount}<br>
            ƒêi·ªÉm trung b√¨nh: ${data.newFormatAverage} ‚≠ê
          `;
          
          // Th√™m v√†o stat card ƒë·∫ßu ti√™n n·∫øu ch∆∞a c√≥
          const firstStatCard = document.querySelector('.stat-card');
          if (firstStatCard && !firstStatCard.querySelector('.new-format-info')) {
            newFormatInfo.className = 'new-format-info';
            firstStatCard.appendChild(newFormatInfo);
          }
        }
      }

      // C·∫≠p nh·∫≠t th·ªëng k√™ theo lƒ©nh v·ª±c
      updateServiceStats(data.serviceStats);
    }

    function updateServiceStats(serviceStats) {
      const container = document.getElementById('serviceStatsContainer');
      container.innerHTML = '';
      
      if (!serviceStats || Object.keys(serviceStats).length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™ theo lƒ©nh v·ª±c</p>';
        return;
      }

      const statsGrid = document.createElement('div');
      statsGrid.className = 'service-stats';
      
      Object.entries(serviceStats).forEach(([service, stats]) => {
        const card = document.createElement('div');
        card.className = 'service-stat-card';
        
        card.innerHTML = `
          <h4>${service} (${stats.count} ƒë√°nh gi√°)</h4>
          <div class="service-stat-grid">
            <div class="service-stat-item">
              <span>Ph·ª•c v·ª•:</span>
              <div>
                <span class="service-stat-stars">${createStars(parseFloat(stats.averages.serviceRating))}</span>
                <span style="margin-left: 5px;">(${stats.averages.serviceRating})</span>
              </div>
            </div>
            <div class="service-stat-item">
              <span>Th·ªùi gian:</span>
              <div>
                <span class="service-stat-stars">${createStars(parseFloat(stats.averages.time))}</span>
                <span style="margin-left: 5px;">(${stats.averages.time})</span>
              </div>
            </div>
            <div class="service-stat-item">
              <span>Th√°i ƒë·ªô:</span>
              <div>
                <span class="service-stat-stars">${createStars(parseFloat(stats.averages.attitude))}</span>
                <span style="margin-left: 5px;">(${stats.averages.attitude})</span>
              </div>
            </div>
            <div class="service-stat-item">
              <span>T·ªïng th·ªÉ:</span>
              <div>
                <span class="service-stat-stars">${createStars(parseFloat(stats.averages.overall))}</span>
                <span style="margin-left: 5px;">(${stats.averages.overall})</span>
              </div>
            </div>
          </div>
        `;
        
        statsGrid.appendChild(card);
      });
      
      container.appendChild(statsGrid);
    }

    function sortRatings(ratings, sortOrder) {
      const sortedRatings = [...ratings];
      
      switch (sortOrder) {
        case 'newest':
          return sortedRatings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        case 'oldest':
          return sortedRatings.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        case 'highest':
          return sortedRatings.sort((a, b) => b.overall - a.overall);
        case 'lowest':
          return sortedRatings.sort((a, b) => a.overall - b.overall);
        default:
          return sortedRatings;
      }
    }

    function updateTable() {
      const sortOrder = document.getElementById('sortOrder').value;
      const sortedRatings = sortRatings(ratingsData, sortOrder);
      
      const tbody = document.getElementById('ratingsTableBody');
      tbody.innerHTML = '';
      
      sortedRatings.forEach(rating => {
        const row = document.createElement('tr');
        
        // Ki·ªÉm tra format ƒë√°nh gi√° (c≈© c√≥ ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng, m·ªõi ch·ªâ c√≥ overall)
        const isOldFormat = rating.serviceRating !== undefined && 
                           rating.time !== undefined && 
                           rating.attitude !== undefined;
        
        if (isOldFormat) {
          // Format c≈© - hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß
          row.innerHTML = `
            <td>${formatDate(rating.timestamp)}</td>
            <td style="font-weight: bold; color: #1976d2;">${rating.service}</td>
            <td><span class="rating-stars">${createStars(rating.serviceRating)}</span> (${rating.serviceRating})</td>
            <td><span class="rating-stars">${createStars(rating.time)}</span> (${rating.time})</td>
            <td><span class="rating-stars">${createStars(rating.attitude)}</span> (${rating.attitude})</td>
            <td><span class="rating-stars">${createStars(rating.overall)}</span> (${rating.overall})</td>
            <td class="comment-cell">${rating.comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</td>
          `;
        } else {
          // Format m·ªõi - ch·ªâ hi·ªÉn th·ªã overall, c√°c tr∆∞·ªùng kh√°c ƒë·ªÉ tr·ªëng
          row.innerHTML = `
            <td>${formatDate(rating.timestamp)}</td>
            <td style="font-weight: bold; color: #1976d2;">${rating.service}</td>
            <td style="color: #999; font-style: italic;">-</td>
            <td style="color: #999; font-style: italic;">-</td>
            <td style="color: #999; font-style: italic;">-</td>
            <td><span class="rating-stars">${createStars(rating.overall)}</span> (${rating.overall})</td>
            <td class="comment-cell">${rating.comment || 'Kh√¥ng c√≥ √Ω ki·∫øn'}</td>
          `;
        }
        
        // Th√™m customer code n·∫øu c√≥
        if (rating.customerCode && rating.customerCode.trim()) {
          const customerCodeSpan = `<br><small style="color: #4caf50; font-weight: bold;">M√£ KH: ${rating.customerCode}</small>`;
          const serviceCell = row.children[1];
          serviceCell.innerHTML += customerCodeSpan;
        }
        
        tbody.appendChild(row);
      });
    }

    async function loadRatingsReport() {
      try {
        document.getElementById('loadingMessage').style.display = 'block';
        document.getElementById('reportContent').style.display = 'none';
        document.getElementById('noDataMessage').style.display = 'none';

        const response = await fetch('/ratings-report');
        const data = await response.json();

        document.getElementById('loadingMessage').style.display = 'none';

        if (data.totalRatings === 0) {
          document.getElementById('noDataMessage').style.display = 'block';
        } else {
          ratingsData = data.ratings;
          updateStatistics(data);
          updateTable();
          document.getElementById('reportContent').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading ratings report:', error);
        document.getElementById('loadingMessage').textContent = 'C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu.';
      }
    }

    function goBack() {
      window.location.href = 'admin.html';
    }

    // Export to Excel function (scientific format)
    function exportToExcel() {
      if (!ratingsData || ratingsData.length === 0) {
        alert('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
        return;
      }

      try {
        // T√≠nh to√°n th·ªëng k√™ t·ªïng quan
        const stats = calculateAdvancedStatistics(ratingsData);
        const currentDate = new Date().toLocaleDateString('vi-VN');
        const currentTime = new Date().toLocaleTimeString('vi-VN');
        
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        
        // Ti√™u ƒë·ªÅ b√°o c√°o
        csvContent += "B√ÅO C√ÅO T·ªîNG H·ª¢P ƒê√ÅNH GI√Å M·ª®C ƒê·ªò H√ÄI L√íNG\n";
        csvContent += "H·ªá th·ªëng qu·∫£n l√Ω x·∫øp h√†ng - Trung t√¢m ph·ª•c v·ª• h√†nh ch√≠nh c√¥ng\n";
        csvContent += `"Ng√†y xu·∫•t b√°o c√°o: ${currentDate} l√∫c ${currentTime}"\n`;
        csvContent += `"Th·ªùi gian kh·∫£o s√°t: ${stats.surveyPeriod}"\n`;
        csvContent += "\n";
        
        // T√≥m t·∫Øt th·ªëng k√™
        csvContent += "T√ìM T·∫ÆT K·∫æT QU·∫¢ KH·∫¢O S√ÅT\n";
        csvContent += "Ch·ªâ s·ªë,Gi√° tr·ªã\n";
        csvContent += `"T·ªïng s·ªë phi·∫øu ƒë√°nh gi√°","${ratingsData.length}"\n`;
        csvContent += `"ƒêi·ªÉm trung b√¨nh chung","${stats.overallAverage}/5 sao"\n`;
        csvContent += `"T·ª∑ l·ªá h√†i l√≤ng (‚â•4 sao)","${stats.satisfactionRate}%"\n`;
        csvContent += `"Phi·∫øu ƒë√°nh gi√° cao nh·∫•t","${stats.highestRating}/5 sao"\n`;
        csvContent += `"Phi·∫øu ƒë√°nh gi√° th·∫•p nh·∫•t","${stats.lowestRating}/5 sao"\n`;
        csvContent += `"S·ªë d·ªãch v·ª• ƒë∆∞·ª£c ƒë√°nh gi√°","${stats.serviceCount}"\n`;
        csvContent += "\n";
        
        // B·∫£ng ƒëi·ªÉm chi ti·∫øt (cho format c≈©)
        const oldFormatRatings = ratingsData.filter(r => r.serviceRating !== undefined);
        if (oldFormatRatings.length > 0) {
          csvContent += "ƒêI·ªÇM TRUNG B√åNH THEO TI√äU CH√ç (Format c≈©)\n";
          csvContent += "Ti√™u ch√≠ ƒë√°nh gi√°,ƒêi·ªÉm trung b√¨nh,X·∫øp lo·∫°i\n";
          const serviceAvg = calculateAverage(oldFormatRatings, 'serviceRating');
          const timeAvg = calculateAverage(oldFormatRatings, 'time');
          const attitudeAvg = calculateAverage(oldFormatRatings, 'attitude');
          const overallAvg = calculateAverage(oldFormatRatings, 'overall');
          
          csvContent += `"Ch·∫•t l∆∞·ª£ng d·ªãch v·ª•","${serviceAvg}/5","${getRatingCategory(serviceAvg)}"\n`;
          csvContent += `"Th·ªùi gian x·ª≠ l√Ω","${timeAvg}/5","${getRatingCategory(timeAvg)}"\n`;
          csvContent += `"Th√°i ƒë·ªô ph·ª•c v·ª•","${attitudeAvg}/5","${getRatingCategory(attitudeAvg)}"\n`;
          csvContent += `"ƒê√°nh gi√° t·ªïng th·ªÉ","${overallAvg}/5","${getRatingCategory(overallAvg)}"\n`;
          csvContent += "\n";
        }
        
        // Th·ªëng k√™ theo d·ªãch v·ª•
        csvContent += "TH·ªêNG K√ä THEO Lƒ®NH V·ª∞C D·ªäCH V·ª§\n";
        csvContent += "Lƒ©nh v·ª±c d·ªãch v·ª•,S·ªë l∆∞·ª£ng ƒë√°nh gi√°,ƒêi·ªÉm trung b√¨nh,T·ª∑ l·ªá h√†i l√≤ng,X·∫øp h·∫°ng\n";
        
        const serviceStats = stats.serviceBreakdown.sort((a, b) => b.average - a.average);
        serviceStats.forEach((service, index) => {
          csvContent += `"${service.name}","${service.count}","${service.average}/5","${service.satisfactionRate}%","${index + 1}"\n`;
        });
        csvContent += "\n";
        
        // Ph√¢n b·ªë ƒë√°nh gi√° chi ti·∫øt
        csvContent += "PH√ÇN B·ªê M·ª®C ƒê·ªò H√ÄI L√íNG\n";
        csvContent += "M·ª©c ƒë√°nh gi√°,M√¥ t·∫£,S·ªë l∆∞·ª£ng,T·ª∑ l·ªá,Bi·ªÉu ƒë·ªì\n";
        for (let i = 5; i >= 1; i--) {
          const count = stats.ratingDistribution[i] || 0;
          const percentage = ((count / ratingsData.length) * 100).toFixed(1);
          const description = getSatisfactionDescription(i);
          const chart = '‚ñà'.repeat(Math.round(percentage / 5)); // Simple chart
          csvContent += `"${i} sao","${description}","${count}","${percentage}%","${chart}"\n`;
        }
        csvContent += "\n";
        
        // Xu h∆∞·ªõng theo th·ªùi gian (theo ng√†y)
        csvContent += "XU H∆Ø·ªöNG ƒê√ÅNH GI√Å THEO TH·ªúI GIAN\n";
        csvContent += "Ng√†y,S·ªë l∆∞·ª£ng ƒë√°nh gi√°,ƒêi·ªÉm trung b√¨nh,Ghi ch√∫\n";
        const dailyStats = stats.dailyTrend;
        Object.keys(dailyStats).sort().forEach(date => {
          const dayStats = dailyStats[date];
          const trend = dayStats.average >= 4 ? 'T√≠ch c·ª±c' : dayStats.average >= 3 ? 'Trung b√¨nh' : 'C·∫ßn c·∫£i thi·ªán';
          csvContent += `"${date}","${dayStats.count}","${dayStats.average}/5","${trend}"\n`;
        });
        csvContent += "\n";
        
        // Chi ti·∫øt t·ª´ng ƒë√°nh gi√°
        csvContent += "CHI TI·∫æT C√ÅC PHI·∫æU ƒê√ÅNH GI√Å\n";
        csvContent += "STT,Ng√†y gi·ªù,M√£ kh√°ch h√†ng,Lƒ©nh v·ª±c d·ªãch v·ª•,Ch·∫•t l∆∞·ª£ng DV,Th·ªùi gian XL,Th√°i ƒë·ªô PV,T·ªïng th·ªÉ,M·ª©c ƒë·ªô H√ÄI L√íNG,√ù ki·∫øn g√≥p √Ω\n";
        
        ratingsData.forEach((rating, index) => {
          const stt = index + 1;
          const datetime = new Date(rating.timestamp).toLocaleString('vi-VN');
          const customerCode = rating.customerCode || 'N/A';
          const service = rating.service;
          const serviceRating = rating.serviceRating || '-';
          const timeRating = rating.time || '-';
          const attitudeRating = rating.attitude || '-';
          const overallRating = rating.overall || '-';
          const satisfaction = getSatisfactionDescription(rating.overall);
          const comment = (rating.comment || 'Kh√¥ng c√≥ √Ω ki·∫øn').replace(/,/g, ';').replace(/"/g, '""');
          
          csvContent += `"${stt}","${datetime}","${customerCode}","${service}","${serviceRating}","${timeRating}","${attitudeRating}","${overallRating}","${satisfaction}","${comment}"\n`;
        });
        
        // Footer
        csvContent += "\n";
        csvContent += "TH√îNG TIN B·ªî SUNG\n";
        csvContent += '"Ghi ch√∫"\n';
        csvContent += '"- Thang ƒëi·ªÉm ƒë√°nh gi√°: 1 (R·∫•t kh√¥ng h√†i l√≤ng) ƒë·∫øn 5 (R·∫•t h√†i l√≤ng)"\n';
        csvContent += '"- T·ª∑ l·ªá h√†i l√≤ng = S·ªë ƒë√°nh gi√° ‚â•4 sao / T·ªïng s·ªë ƒë√°nh gi√° √ó 100%"\n';
        csvContent += '"- DV: D·ªãch v·ª•, XL: X·ª≠ l√Ω, PV: Ph·ª•c v·ª•"\n';
        csvContent += '"- D·ªØ li·ªáu ƒë∆∞·ª£c t·ªïng h·ª£p t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng"\n';

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `bao-cao-tong-hop-danh-gia-${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`‚úÖ ƒê√£ xu·∫•t b√°o c√°o khoa h·ªçc v·ªõi ${ratingsData.length} ƒë√°nh gi√° th√†nh c√¥ng!\nüìä Bao g·ªìm: Th·ªëng k√™ t·ªïng quan, ph√¢n t√≠ch theo d·ªãch v·ª•, xu h∆∞·ªõng th·ªùi gian`);
      } catch (error) {
        console.error('Export error:', error);
        alert('‚ùå L·ªói khi xu·∫•t file. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    }

    // H√†m t√≠nh to√°n th·ªëng k√™ n√¢ng cao
    function calculateAdvancedStatistics(ratings) {
      const totalRatings = ratings.reduce((sum, r) => sum + (r.overall || 0), 0);
      const overallAverage = (totalRatings / ratings.length).toFixed(1);
      const satisfiedCount = ratings.filter(r => (r.overall || 0) >= 4).length;
      const satisfactionRate = ((satisfiedCount / ratings.length) * 100).toFixed(1);
      
      const allRatings = ratings.map(r => r.overall || 0);
      const highestRating = Math.max(...allRatings);
      const lowestRating = Math.min(...allRatings);
      
      // Th·ªëng k√™ theo d·ªãch v·ª•
      const serviceBreakdown = {};
      ratings.forEach(rating => {
        const service = rating.service;
        if (!serviceBreakdown[service]) {
          serviceBreakdown[service] = { count: 0, total: 0, satisfied: 0 };
        }
        serviceBreakdown[service].count++;
        serviceBreakdown[service].total += rating.overall || 0;
        if ((rating.overall || 0) >= 4) serviceBreakdown[service].satisfied++;
      });
      
      const serviceStats = Object.keys(serviceBreakdown).map(service => {
        const data = serviceBreakdown[service];
        return {
          name: service,
          count: data.count,
          average: (data.total / data.count).toFixed(1),
          satisfactionRate: ((data.satisfied / data.count) * 100).toFixed(1)
        };
      });
      
      // Ph√¢n b·ªë ƒë√°nh gi√°
      const ratingDistribution = {};
      for (let i = 1; i <= 5; i++) {
        ratingDistribution[i] = ratings.filter(r => (r.overall || 0) === i).length;
      }
      
      // Xu h∆∞·ªõng theo ng√†y
      const dailyTrend = {};
      ratings.forEach(rating => {
        const date = new Date(rating.timestamp).toLocaleDateString('vi-VN');
        if (!dailyTrend[date]) {
          dailyTrend[date] = { count: 0, total: 0 };
        }
        dailyTrend[date].count++;
        dailyTrend[date].total += rating.overall || 0;
      });
      
      Object.keys(dailyTrend).forEach(date => {
        const data = dailyTrend[date];
        data.average = (data.total / data.count).toFixed(1);
      });
      
      // Th·ªùi gian kh·∫£o s√°t
      const timestamps = ratings.map(r => new Date(r.timestamp));
      const earliestDate = new Date(Math.min(...timestamps)).toLocaleDateString('vi-VN');
      const latestDate = new Date(Math.max(...timestamps)).toLocaleDateString('vi-VN');
      const surveyPeriod = earliestDate === latestDate ? earliestDate : `${earliestDate} - ${latestDate}`;
      
      return {
        overallAverage,
        satisfactionRate,
        highestRating,
        lowestRating,
        serviceCount: Object.keys(serviceBreakdown).length,
        serviceBreakdown: serviceStats,
        ratingDistribution,
        dailyTrend,
        surveyPeriod
      };
    }

    // T√≠nh trung b√¨nh cho m·ªôt ti√™u ch√≠
    function calculateAverage(ratings, field) {
      const total = ratings.reduce((sum, r) => sum + (r[field] || 0), 0);
      return (total / ratings.length).toFixed(1);
    }

    // X·∫øp lo·∫°i ƒëi·ªÉm s·ªë
    function getRatingCategory(score) {
      const numScore = parseFloat(score);
      if (numScore >= 4.5) return 'Xu·∫•t s·∫Øc';
      if (numScore >= 4.0) return 'T·ªët';
      if (numScore >= 3.0) return 'Kh√°';
      if (numScore >= 2.0) return 'Trung b√¨nh';
      return 'C·∫ßn c·∫£i thi·ªán';
    }

    // M√¥ t·∫£ m·ª©c ƒë·ªô h√†i l√≤ng
    function getSatisfactionDescription(score) {
      if (score >= 5) return 'R·∫•t h√†i l√≤ng';
      if (score >= 4) return 'H√†i l√≤ng';
      if (score >= 3) return 'B√¨nh th∆∞·ªùng';
      if (score >= 2) return 'Kh√¥ng h√†i l√≤ng';
      return 'R·∫•t kh√¥ng h√†i l√≤ng';
    }

    // Event listeners
    document.getElementById('sortOrder').addEventListener('change', updateTable);

    // Load data when page loads
    loadRatingsReport();
  </script>
</body>
</html>
