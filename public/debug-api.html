<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug API</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section h2 {
      color: #1976d2;
      margin-top: 0;
    }
    
    button {
      background: #1976d2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    
    button:hover {
      background: #1565c0;
    }
    
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .success {
      color: #4caf50;
      font-weight: bold;
    }
    
    .error {
      color: #f44336;
      font-weight: bold;
    }
    
    .info {
      color: #2196f3;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üõ†Ô∏è Debug API Endpoints</h1>
  
  <div class="section">
    <h2>üìä Ratings API</h2>
    <button onclick="testRatingsReport()">Test /ratings-report</button>
    <button onclick="testStats()">Test /stats</button>
    <button onclick="testHistory()">Test /api/history</button>
    <button onclick="clearResults()">Clear Results</button>
    <div id="results"></div>
  </div>
  
  <div class="section">
    <h2>üìà Statistics Summary</h2>
    <div id="summary"></div>
  </div>

  <script>
    function log(message, type = 'info') {
      const results = document.getElementById('results');
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
      results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('summary').innerHTML = '';
    }

    async function testRatingsReport() {
      log('üîç Testing /ratings-report endpoint...');
      
      try {
        const response = await fetch('/ratings-report');
        const data = await response.json();
        
        if (response.ok) {
          log('‚úÖ /ratings-report success', 'success');
          log(`üìä Total Ratings: ${data.totalRatings}`);
          log(`üìä Old Format: ${data.oldFormatCount}, New Format: ${data.newFormatCount}`);
          log(`üìä Ratings Array Length: ${data.ratings ? data.ratings.length : 'undefined'}`);
          
          // Count today's ratings
          const today = new Date().toISOString().split('T')[0];
          if (data.ratings && Array.isArray(data.ratings)) {
            const todayRatings = data.ratings.filter(rating => {
              const ratingDate = rating.timestamp.split('T')[0];
              return ratingDate === today;
            });
            log(`üìÖ Today's Ratings (${today}): ${todayRatings.length}`, 'success');
            
            if (todayRatings.length > 0) {
              log('üìã Today\'s ratings details:');
              todayRatings.forEach((rating, index) => {
                log(`  ${index + 1}. Service: ${rating.service}, Overall: ${rating.overall}, Customer Code: ${rating.customerCode || 'N/A'}`);
              });
            }
          }
          
          document.getElementById('summary').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        } else {
          log(`‚ùå /ratings-report error: ${response.status}`, 'error');
        }
      } catch (error) {
        log(`‚ùå /ratings-report fetch error: ${error.message}`, 'error');
      }
    }

    async function testStats() {
      log('üîç Testing /stats endpoint...');
      
      try {
        const response = await fetch('/stats');
        const data = await response.json();
        
        if (response.ok) {
          log('‚úÖ /stats success', 'success');
          log(`üìä Queue count: ${Object.keys(data.queue).length}`);
          log(`üìä History count: ${Object.keys(data.history).length}`);
          
          // Count today's calls
          const today = new Date().toISOString().split('T')[0];
          let todayCallsCount = 0;
          
          Object.values(data.history).forEach(calls => {
            if (Array.isArray(calls)) {
              const todayCalls = calls.filter(call => call.time.startsWith(today));
              todayCallsCount += todayCalls.length;
            }
          });
          
          log(`üìÖ Today's calls: ${todayCallsCount}`, 'success');
          
          const waitingCount = Object.values(data.queue).reduce((total, queue) => total + queue.length, 0);
          log(`‚è≥ Waiting in queue: ${waitingCount}`, 'success');
          
        } else {
          log(`‚ùå /stats error: ${response.status}`, 'error');
        }
      } catch (error) {
        log(`‚ùå /stats fetch error: ${error.message}`, 'error');
      }
    }

    async function testHistory() {
      log('üîç Testing /api/history endpoint...');
      
      try {
        const response = await fetch('/api/history');
        const data = await response.json();
        
        if (response.ok) {
          log('‚úÖ /api/history success', 'success');
          log(`üìä Total history records: ${data.length}`);
          
          // Count today's records
          const today = new Date().toISOString().split('T')[0];
          const todayRecords = data.filter(record => record.time.startsWith(today));
          log(`üìÖ Today's history records: ${todayRecords.length}`, 'success');
          
          if (todayRecords.length > 0) {
            log('üìã Today\'s calls:');
            todayRecords.forEach((record, index) => {
              const customerCode = generateCustomerCode(record.time, record.number);
              log(`  ${index + 1}. Service: ${record.service}, Number: ${record.number}, Code: ${customerCode}`);
            });
          }
          
        } else {
          log(`‚ùå /api/history error: ${response.status}`, 'error');
        }
      } catch (error) {
        log(`‚ùå /api/history fetch error: ${error.message}`, 'error');
      }
    }

    function generateCustomerCode(dateString, number) {
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = String(date.getFullYear()).slice(-2);
      return `${day}${month}${year}-${number}`;
    }

    // Auto-run tests on page load
    window.addEventListener('load', () => {
      log('üöÄ Page loaded, running automatic tests...');
      setTimeout(() => {
        testRatingsReport();
        setTimeout(() => {
          testStats();
          setTimeout(() => {
            testHistory();
          }, 1000);
        }, 1000);
      }, 500);
    });
  </script>
</body>
</html>
