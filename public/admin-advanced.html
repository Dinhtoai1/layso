<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n tr·ªã N√¢ng cao - LaySo System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3vh;
      align-items: start;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 2.5vh;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
    }

    .full-width {
      grid-column: 1 / -1;
    }

    h1 {
      color: white;
      text-align: center;
      margin-bottom: 3vh;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    h2 {
      color: #4a5568;
      margin-bottom: 2vh;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h3 {
      color: #2d3748;
      margin-bottom: 1.5vh;
      font-size: 1.2em;
    }

    /* Stats overview */
    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5vh;
      margin-bottom: 3vh;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2vh;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 0.5vh;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }

    /* Chart section */
    .chart-section {
      margin-bottom: 3vh;
    }

    .star-distribution {
      display: flex;
      flex-direction: column;
      gap: 1vh;
      margin-bottom: 2vh;
    }

    .star-bar {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .star-label {
      width: 60px;
      font-weight: bold;
      color: #f59e0b;
    }

    .star-progress {
      flex: 1;
      height: 25px;
      background: #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .star-fill {
      height: 100%;
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
      border-radius: 12px;
      transition: width 0.8s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.9em;
    }

    /* Service stats */
    .service-stats {
      margin-bottom: 3vh;
    }

    .service-item {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 2vh;
      margin-bottom: 1.5vh;
    }

    .service-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1vh;
    }

    .service-name {
      font-weight: bold;
      color: #2d3748;
      flex: 1;
    }

    .service-score {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.5vh 1.5vh;
      border-radius: 20px;
      font-weight: bold;
    }

    .service-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1vh;
      margin-top: 1vh;
    }

    .service-detail {
      text-align: center;
      padding: 1vh;
      background: white;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .detail-number {
      font-size: 1.5em;
      font-weight: bold;
      color: #4c51bf;
    }

    .detail-label {
      font-size: 0.8em;
      color: #718096;
      margin-top: 0.5vh;
    }

    /* Reports grid */
    .reports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5vh;
    }

    .report-btn {
      display: block;
      padding: 2vh;
      background: linear-gradient(135deg, #4c51bf 0%, #667eea 100%);
      color: white;
      text-decoration: none;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 81, 191, 0.2);
    }

    .report-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 81, 191, 0.3);
    }

    .report-btn.green {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.2);
    }

    .report-btn.green:hover {
      box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
    }

    .report-btn.purple {
      background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
      box-shadow: 0 4px 15px rgba(159, 122, 234, 0.2);
    }

    .report-btn.purple:hover {
      box-shadow: 0 8px 25px rgba(159, 122, 234, 0.3);
    }

    /* Buttons */
    .refresh-btn {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border: none;
      padding: 1.5vh 3vh;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.2);
      width: 100%;
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
    }

    /* Loading states */
    .loading {
      text-align: center;
      color: #718096;
      font-style: italic;
      padding: 2vh;
    }

    /* Error states */
    .error {
      text-align: center;
      color: #e53e3e;
      background: #fed7d7;
      padding: 2vh;
      border-radius: 8px;
      margin: 1vh 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        padding: 1vh;
      }
      
      .stats-overview {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .reports-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>üè¢ Qu·∫£n tr·ªã N√¢ng cao LaySo System</h1>
  
  <div class="container">
    <!-- Th·ªëng k√™ ƒë√°nh gi√° -->
    <div class="card full-width">
      <h2>üìä Th·ªëng k√™ ƒê√°nh gi√° Chi ti·∫øt</h2>
      
      <!-- T·ªïng quan h·ªá th·ªëng -->
      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-number" id="totalRatings">-</div>
          <div class="stat-label">T·ªïng ƒë√°nh gi√°</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgRating">-</div>
          <div class="stat-label">ƒêi·ªÉm trung b√¨nh</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="todayRatings">-</div>
          <div class="stat-label">ƒê√°nh gi√° h√¥m nay</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="weekRatings">-</div>
          <div class="stat-label">ƒê√°nh gi√° tu·∫ßn n√†y</div>
        </div>
      </div>

      <!-- Bi·ªÉu ƒë·ªì ph√¢n b·ªë sao -->
      <div class="chart-section">
        <h3>üìà Ph√¢n b·ªë ƒëi·ªÉm ƒë√°nh gi√°</h3>
        <div class="star-distribution" id="starDistribution">
          <div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
      </div>

      <button onclick="loadStatistics()" class="refresh-btn">
        üîÑ C·∫≠p nh·∫≠t th·ªëng k√™
      </button>
    </div>

    <!-- Th·ªëng k√™ theo d·ªãch v·ª• -->
    <div class="card full-width">
      <div class="service-stats" id="serviceStats">
        <h3>üè¢ Th·ªëng k√™ theo d·ªãch v·ª•</h3>
        <div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      </div>
    </div>

    <!-- C√¥ng c·ª• qu·∫£n tr·ªã -->
    <div class="card">
      <h2>üîß C√¥ng c·ª• Qu·∫£n tr·ªã</h2>
      <div class="reports-grid">
        <a href="javascript:void(0)" onclick="exportRatingsExcel()" class="report-btn green">
          üìã Xu·∫•t Excel ƒë√°nh gi√°
        </a>
        <a href="ratings-detail.html" target="_blank" class="report-btn">
          üóÇÔ∏è Chi ti·∫øt ƒë√°nh gi√°
        </a>
        <a href="home.html" target="_blank" class="report-btn">
          üè† Trang l·∫•y s·ªë
        </a>
      </div>
    </div>

    <!-- M√†n h√¨nh hi·ªÉn th·ªã -->
    <div class="card">
      <h2>üì∫ M√†n h√¨nh Hi·ªÉn th·ªã</h2>
      <div class="reports-grid">
        <a href="javascript:void(0)" onclick="openNumberDisplay()" class="report-btn purple">
          üì∫ M√†n h√¨nh s·ªë th·ª© t·ª±
        </a>
        <a href="javascript:void(0)" onclick="openAllCountersDisplay()" class="report-btn purple">
          üñ•Ô∏è M√†n h√¨nh t·ªïng h·ª£p
        </a>
      </div>
    </div>
  </div>

  <script>
    // Variables
    let ratingsData = null;

    // Load statistics on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Trang admin-advanced ƒë√£ t·∫£i');
      loadStatistics();
    });

    // Load and display statistics
    async function loadStatistics() {
      console.log('üìä ƒêang t·∫£i th·ªëng k√™...');
      try {
        // Auto-detect API URL based on current host
        const apiBaseUrl = window.location.hostname === 'localhost' ? 
          'http://localhost:3000' : 'https://layso.onrender.com';
        
        const response = await fetch(`${apiBaseUrl}/ratings-report`);
        console.log('üì° Response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        ratingsData = await response.json();
        console.log('üìà D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:', ratingsData);
        
        displayOverviewStats();
        displayStarDistribution();
        displayServiceStats();
      } catch (error) {
        console.error('‚ùå L·ªói t·∫£i th·ªëng k√™:', error);
        showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ªëng k√™: ' + error.message);
      }
    }

    // Display overview statistics
    function displayOverviewStats() {
      console.log('üìã Hi·ªÉn th·ªã th·ªëng k√™ t·ªïng quan');
      if (!ratingsData || !ratingsData.systemStats) {
        console.log('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu systemStats');
        return;
      }

      const { systemStats } = ratingsData;
      console.log('üìä SystemStats:', systemStats);
  // M·ªôt s·ªë field backend ƒë√£ .toFixed(1) n√™n l√† string => c·∫ßn parseFloat tr∆∞·ªõc khi .toFixed
  const totalRatings = Number(systemStats.totalRatings) || 0;
  const avgOverallNum = parseFloat(systemStats.totalOverallAverage) || 0;
  const todayRatings = Number(systemStats.todayRatings) || 0;
  const weekRatings = Number(systemStats.thisWeekRatings) || 0;

  document.getElementById('totalRatings').textContent = totalRatings;
  document.getElementById('avgRating').textContent = avgOverallNum.toFixed(1) + '/5';
  document.getElementById('todayRatings').textContent = todayRatings;
  document.getElementById('weekRatings').textContent = weekRatings;
    }

    // Display star distribution chart
    function displayStarDistribution() {
      console.log('‚≠ê Hi·ªÉn th·ªã ph√¢n b·ªë sao');
      if (!ratingsData || !ratingsData.ratings) {
        console.log('‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ratings');
        return;
      }

      const { ratings } = ratingsData;
      const distribution = {};
      
      // Count ratings by star
      for (let i = 1; i <= 5; i++) {
        distribution[i] = ratings.filter(r => r.overall === i).length;
      }

      const total = Object.values(distribution).reduce((sum, count) => sum + count, 0);
      const container = document.getElementById('starDistribution');
      
      console.log('üìä Ph√¢n b·ªë sao:', distribution, 'T·ªïng:', total);
      
      if (total === 0) {
        container.innerHTML = '<div class="loading">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</div>';
        return;
      }

      let html = '';
      for (let star = 5; star >= 1; star--) {
        const count = distribution[star] || 0;
        const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
        
        html += `
          <div class="star-bar">
            <div class="star-label">${star}‚≠ê</div>
            <div class="star-progress">
              <div class="star-fill" style="width: ${percentage}%">
                ${count} (${percentage}%)
              </div>
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    // Display service statistics
    function displayServiceStats() {
      console.log('üè¢ Hi·ªÉn th·ªã th·ªëng k√™ d·ªãch v·ª•');
      if (!ratingsData) {
        console.log('‚ö†Ô∏è Kh√¥ng c√≥ ratingsData');
        return;
      }

      // Backend tr·∫£ v·ªÅ serviceStats (alias c·ªßa serviceBreakdown) d·∫°ng { service: { count, avgRating, totalRating } }
      const serviceStats = ratingsData.serviceStats || ratingsData.serviceBreakdown;
      const container = document.getElementById('serviceStats');
      
      console.log('üè¢ ServiceStats:', serviceStats);
      
      if (Object.keys(serviceStats).length === 0) {
        container.innerHTML = '<h3>üè¢ Th·ªëng k√™ theo d·ªãch v·ª•</h3><div class="loading">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
        return;
      }

      let html = '<h3>üè¢ Th·ªëng k√™ theo d·ªãch v·ª•</h3>';
      const allRatings = ratingsData.ratings || [];

      for (const [serviceName, statsRaw] of Object.entries(serviceStats)) {
        const serviceRatings = allRatings.filter(r => r.service === serviceName);
        const totalCount = statsRaw.count || serviceRatings.length;

        // T√≠nh ph√¢n b·ªë sao (l√†m tr√≤n overall v·ªÅ s·ªë nguy√™n 1-5)
        const distribution = { star1:0, star2:0, star3:0, star4:0, star5:0 };
        serviceRatings.forEach(r => {
          const star = Math.round(r.overall || 0);
            if (star >=1 && star <=5) distribution['star'+star]++;
        });

        // ƒêi·ªÉm trung b√¨nh
        let overallAverage = statsRaw.avgRating ? parseFloat(statsRaw.avgRating) : 0;
        if (!overallAverage && serviceRatings.length > 0) {
          overallAverage = serviceRatings.reduce((s,r)=> s + (r.overall||0),0) / serviceRatings.length;
        }

        // S·ªë ƒë√°nh gi√° c√≥ comment
        const hasComments = serviceRatings.filter(r => (r.comment||'').trim().length > 0).length;

        const starIcons = '‚≠ê'.repeat(Math.round(overallAverage));

        html += `
          <div class="service-item">
            <div class="service-header">
              <div class="service-name">${serviceName}</div>
              <div class="service-score">${overallAverage.toFixed(1)}/5 ${starIcons}</div>
            </div>
            <div class="service-details">
              <div class="service-detail">
                <div class="detail-number">${totalCount}</div>
                <div class="detail-label">T·ªïng ƒë√°nh gi√°</div>
              </div>
              <div class="service-detail">
                <div class="detail-number">${distribution.star5}</div>
                <div class="detail-label">5 sao</div>
              </div>
              <div class="service-detail">
                <div class="detail-number">${distribution.star4}</div>
                <div class="detail-label">4 sao</div>
              </div>
              <div class="service-detail">
                <div class="detail-number">${distribution.star3}</div>
                <div class="detail-label">3 sao</div>
              </div>
              <div class="service-detail">
                <div class="detail-number">${distribution.star2}</div>
                <div class="detail-label">2 sao</div>
              </div>
              <div class="service-detail">
                <div class="detail-number">${distribution.star1}</div>
                <div class="detail-label">1 sao</div>
              </div>
              <div class="service-detail">
                <div class="detail-number">${hasComments}</div>
                <div class="detail-label">C√≥ nh·∫≠n x√©t</div>
              </div>
            </div>
          </div>`;
      }

      container.innerHTML = html;
    }

    // Utility functions
    function showError(message) {
      console.error('‚ùå Hi·ªÉn th·ªã l·ªói:', message);
      
      // Show error in stat cards
      document.getElementById('totalRatings').textContent = 'L·ªói';
      document.getElementById('avgRating').textContent = 'L·ªói';
      document.getElementById('todayRatings').textContent = 'L·ªói';
      document.getElementById('weekRatings').textContent = 'L·ªói';
      
      // Show error in charts
      document.getElementById('starDistribution').innerHTML = `<div class="error">${message}</div>`;
      document.getElementById('serviceStats').innerHTML = `<h3>üè¢ Th·ªëng k√™ theo d·ªãch v·ª•</h3><div class="error">${message}</div>`;
    }

    // Export functions
    function exportRatingsExcel() {
      console.log('üìã Xu·∫•t Excel');
      window.open('/export-ratings-excel', '_blank');
    }

    // Display functions
    function openNumberDisplay() {
      console.log('üì∫ M·ªü m√†n h√¨nh s·ªë th·ª© t·ª±');
      window.open('number-display.html', 'numberDisplay', 'width=1200,height=900,scrollbars=yes,resizable=yes');
    }

    function openAllCountersDisplay() {
      console.log('üñ•Ô∏è M·ªü m√†n h√¨nh t·ªïng h·ª£p');
      window.open('all-counters-display.html', 'allCountersDisplay', 'width=1600,height=1000,scrollbars=yes,resizable=yes');
    }

    // Auto-refresh every 30 seconds
    setInterval(function() {
      console.log('üîÑ Auto refresh th·ªëng k√™');
      loadStatistics();
    }, 30000);

    // Test API connection
  fetch('https://layso.onrender.com/ratings-report')
      .then(response => {
        console.log('üîó Test API k·∫øt n·ªëi:', response.status);
        if (response.ok) {
          console.log('‚úÖ API ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng');
        } else {
          console.log('‚ùå API c√≥ v·∫•n ƒë·ªÅ:', response.status);
        }
      })
      .catch(error => {
        console.log('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi API:', error);
      });
  </script>
</body>
</html>
