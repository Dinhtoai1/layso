<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trạng thái tất cả quầy dịch vụ</title>
  <style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    height: 100vh;
    max-height: 100vh;
    overflow: hidden;
    padding: 0;
    margin: 0;
    color: #333;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(255,255,255,0.08) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }
  .container {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 1vh;
    position: relative;
    z-index: 1;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(25px);
    border: 1px solid rgba(255,255,255,0.25);
    padding: 2vh 4vh;
    border-radius: 20px;
    box-shadow: 
      0 10px 40px rgba(0,0,0,0.15),
      inset 0 1px 0 rgba(255,255,255,0.25);
    flex-shrink: 0;
    position: relative;
    height: 14vh;
  }
  .logo-section {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .logo-section img {
    width: 60vh;
    height: 12vh;
    object-fit: contain;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    border-radius: 12px;
  }
  .time {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5vh;
  }
  .time-hour {
    font-size: 3.2vh;
    font-weight: 700;
    color: #00ff88;
    text-shadow: 0 0 10px rgba(0, 255, 136, 0.5), 0 2px 4px rgba(0,0,0,0.5);
    letter-spacing: 1px;
  }
  .time-date {
    font-size: 1.6vh;
    font-weight: 500;
    color: rgba(255,255,255,0.9);
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    white-space: nowrap;
  }
  .counters-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: 1fr;
    gap: 2vh;
    flex: 1;
    height: calc(100vh - 14vh);
    padding: 2vh 3vh;
    justify-content: center;
    align-content: center;
    max-width: 100%;
    margin: 0 auto;
    place-items: stretch;
  }
  .counter-card {
    background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
    backdrop-filter: blur(30px);
    border: 2px solid rgba(255,255,255,0.2);
    padding: 1.8vh;
    border-radius: 20px;
    box-shadow: 
      0 12px 40px rgba(0,0,0,0.18),
      inset 0 2px 0 rgba(255,255,255,0.3);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 0.6vh solid rgba(255,255,255,0.5);
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
    position: relative;
    aspect-ratio: 3/4;
  }
  .counter-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }
  .counter-card.active {
    border-left-color: #00ff88;
    background: linear-gradient(145deg, rgba(0, 255, 136, 0.2), rgba(0, 255, 136, 0.1));
    transform: translateY(-3px) scale(1.01);
    box-shadow: 
      0 20px 60px rgba(0, 255, 136, 0.3),
      inset 0 2px 0 rgba(255,255,255,0.4);
  }
  .counter-card:hover {
    transform: translateY(-2px) scale(1.005);
    box-shadow: 0 15px 50px rgba(0,0,0,0.22);
  }
  .counter-header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 1.5vh;
    padding-bottom: 1vh;
    border-bottom: 2px solid rgba(255,255,255,0.3);
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }
  .counter-number {
    font-size: 3vh;
    font-weight: 900;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 0.8vh 1.8vh;
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    flex-shrink: 0;
    border: 2px solid rgba(255,255,255,0.3);
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    letter-spacing: 0.5px;
  }
  .service-name {
    display: none;
  }
  .current-calling {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.08));
    backdrop-filter: blur(15px);
    padding: 2vh 1.5vh;
    border-radius: 15px;
    margin-bottom: 1vh;
    border: 1.5px solid rgba(255, 255, 255, 0.3);
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    position: relative;
    z-index: 1;
  }
  .calling-label {
    font-size: 1.4vh;
    color: rgba(255,255,255,0.9);
    margin-bottom: 0.8vh;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.4);
  }
  .calling-number {
    font-size: 4.5vh;
    font-weight: 900;
    color: #00ff88;
    margin-bottom: 0.8vh;
    text-shadow: 
      0 0 15px rgba(0, 255, 136, 0.6),
      0 3px 6px rgba(0,0,0,0.5);
    text-align: center;
    letter-spacing: 1.5px;
  }
  .calling-time {
    font-size: 1.1vh;
    color: rgba(255,255,255,0.8);
    font-style: italic;
    text-align: center;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    font-weight: 500;
  }
  .no-calling {
    font-size: 2vh;
    color: rgba(255,255,255,0.6);
    text-align: center;
    font-style: italic;
    padding: 1.5vh 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.4);
    font-weight: 600;
  }
  .waiting-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5vh 2vh;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
    backdrop-filter: blur(20px);
    border-radius: 18px;
    border: 2px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }
  .waiting-count {
    font-size: 1.8vh;
    font-weight: 700;
    color: #ffffff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    letter-spacing: 0.5px;
  }
  .waiting-number {
    font-size: 2.5vh;
    font-weight: 900;
    color: #ff4757;
    background: rgba(255, 255, 255, 0.95);
    padding: 0.8vh 1.5vh;
    border-radius: 25px;
    box-shadow: 
      0 6px 20px rgba(0,0,0,0.25),
      inset 0 2px 4px rgba(255, 71, 87, 0.2);
    min-width: 3.5vh;
    text-align: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid rgba(255,71,87,0.4);
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  .waiting-number.highlight {
    animation: bounceGlow 0.8s ease;
    background: #ff9500;
    color: white;
    transform: scale(1.1);
    box-shadow: 
      0 8px 30px rgba(255, 149, 0, 0.5),
      inset 0 2px 4px rgba(255, 149, 0, 0.3);
  }
  .calling-display {
    transition: all 0.4s ease;
  }
  
  @keyframes bounceGlow {
    0%, 100% { transform: scale(1); }
    25% { transform: scale(1.2); box-shadow: 0 0 30px rgba(255, 149, 0, 0.8); }
    50% { transform: scale(1.1); }
    75% { transform: scale(1.15); }
  }
  
  /* Tối ưu đặc biệt cho màn hình 16:9 */
  @media screen and (aspect-ratio: 16/9) {
    .header {
      padding: 1.8vh 3vh;
    }
    .logo-section img {
      width: 36vh;
      height: 11vh;
    }
    .time {
      font-size: 2vh;
      bottom: -1.2vh;
    }
    .counters-grid {
      gap: 2.5vh;
      padding: 2.5vh 3vh;
      height: calc(100vh - 13vh);
    }
    .counter-card {
      padding: 2vh;
    }
    .calling-number {
      font-size: 5vh;
    }
    .counter-number {
      font-size: 3.5vh;
    }
  }
  
  @media screen and (min-width: 1280px) and (max-width: 1920px) and (min-height: 720px) and (max-height: 1080px) {
    .header {
      padding: 2vh 3vh;
    }
    .logo-section img {
      width: 38vh;
      height: 11.5vh;
    }
    .time {
      font-size: 2.1vh;
    }
    .counters-grid {
      gap: 2.8vh;
      max-width: 1350px;
    }
    .counter-card {
      padding: 2.2vh;
    }
  }
  @keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.08); opacity: 0.9; }
    100% { transform: scale(1); opacity: 1; }
  }
  @keyframes newCall {
    0% { transform: scale(1) translateY(-5px); background-color: transparent; }
    25% { transform: scale(1.03) translateY(-8px); background-color: rgba(0, 255, 136, 0.2); }
    50% { transform: scale(1.02) translateY(-6px); background-color: rgba(0, 255, 136, 0.3); }
    75% { transform: scale(1.01) translateY(-5px); background-color: rgba(0, 255, 136, 0.1); }
    100% { transform: scale(1.02) translateY(-5px); background-color: transparent; }
  }
  .refresh-animation {
    animation: fadeInUp 0.6s ease-out;
  }
  @keyframes fadeInUp {
    0% { opacity: 0; transform: translateY(30px) scale(0.95); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }
  @keyframes bounce {
    0%, 20%, 60%, 100% { transform: translateY(0); }
    40% { transform: translateY(-15px); }
    80% { transform: translateY(-8px); }
  }
  @media (max-width: 768px) {
    .header {
      padding: 2vh 2vh;
      flex-direction: column;
      gap: 1.5vh;
      height: auto;
    }
    .logo-section {
      position: relative;
      left: auto;
      top: auto;
      transform: none;
    }
    .logo-section img {
      width: 32vh;
      height: 10vh;
    }
    .time {
      position: relative;
      right: auto;
      top: auto;
      transform: none;
      align-items: center;
    }
    .time-hour {
      font-size: 2.2vh;
    }
    .time-date {
      font-size: 1.2vh;
    }
    .counters-grid {
      grid-template-columns: 1fr;
      gap: 2vh;
      padding: 2vh 1.5vh;
      height: calc(100vh - 12vh);
    }
    .calling-number {
      font-size: 4.5vh;
    }
    .counter-number {
      font-size: 3vh;
      padding: 1vh 2vh;
    }
    .counter-card {
      padding: 2vh 1.5vh;
    }
  }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-section">
        <img src="logo.png" alt="Logo Trung tâm">
      </div>
      <div class="time" id="currentTime">
        <div class="time-hour" id="timeHour"></div>
        <div class="time-date" id="timeDate"></div>
      </div>
    </div>

    <div class="counters-grid" id="countersGrid">
      <!-- Các thẻ quầy sẽ được tạo tự động bằng JavaScript -->
    </div>
  </div>

  <script>
    let lastUpdateTime = null;
    let currentCountersData = {};
    let lastAnnouncementKey = null; // Theo dõi thông báo gần nhất để tránh lặp

    // Hàm phát âm thanh đơn giản như tiếng gõ cửa
    function playKnockSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Tạo 3 tiếng "gõ" liên tiếp
        const times = [0, 0.15, 0.3];
        
        times.forEach(startTime => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          // Tần số thấp giống tiếng gõ cửa
          oscillator.frequency.setValueAtTime(150, audioContext.currentTime + startTime);
          oscillator.frequency.exponentialRampToValueAtTime(80, audioContext.currentTime + startTime + 0.1);
          
          // Âm lượng nhanh lên rồi nhanh xuống
          gainNode.gain.setValueAtTime(0, audioContext.currentTime + startTime);
          gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + startTime + 0.02);
          gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + startTime + 0.1);
          
          oscillator.start(audioContext.currentTime + startTime);
          oscillator.stop(audioContext.currentTime + startTime + 0.1);
        });
      } catch (error) {
        console.log('Không thể phát âm thanh:', error);
      }
    }

    // Hàm thông báo bằng giọng nói tiếng Việt với khoảng cách rõ ràng
    function announceNumber(number, counterNumber, isRecall = false) {
      try {
        console.log(`🎤 announceNumber được gọi: số ${number}, quầy ${counterNumber}${isRecall ? ' (Gọi lại)' : ''}`);
        
        // FORCE CLEAR tất cả speech trước đó
        speechSynthesis.cancel();
        
        // Tạo câu thông báo với ngắt quãng rõ ràng
        const message = isRecall 
          ? `Gọi lại, xin kính mời quý khách có số thứ tự ${number} đến quầy số ${counterNumber} để thực hiện thủ tục hành chính`
          : `Xin kính mời quý khách có số thứ tự ${number} đến quầy số ${counterNumber} để thực hiện thủ tục hành chính`;
        
        console.log('📢 Bắt đầu phát thông báo:', message);
        
        // Tạo utterance
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.lang = 'vi-VN';
        utterance.rate = 0.7;
        utterance.pitch = 1.1;
        utterance.volume = 1.0;
        
        // Tìm giọng tiếng Việt tốt nhất
        const voices = speechSynthesis.getVoices();
        console.log(`� Có ${voices.length} giọng nói có sẵn`);
        
        // Thử tìm giọng Việt
        let vietnameseVoice = voices.find(voice => 
          voice.lang === 'vi-VN' || 
          voice.lang === 'vi' ||
          voice.name.toLowerCase().includes('mai') ||
          voice.name.toLowerCase().includes('linh') ||
          voice.name.toLowerCase().includes('vietnam')
        );
        
        if (vietnameseVoice) {
          utterance.voice = vietnameseVoice;
          console.log(`✅ Sử dụng giọng Việt: ${vietnameseVoice.name} (${vietnameseVoice.lang})`);
        } else {
          console.log('⚠️ Không có giọng Việt, sử dụng giọng mặc định');
        }
        
        // Event listeners
        utterance.onstart = () => {
          console.log('� BẮT ĐẦU PHÁT ÂM THANH');
          // Hiển thị thông báo trên màn hình
          showAnnouncementBanner(message);
        };
        
        utterance.onend = () => {
          console.log('✅ HOÀN THÀNH PHÁT ÂM THANH');
        };
        
        utterance.onerror = (e) => {
          console.log('❌ LỖI PHÁT ÂM:', e.error);
          // Fallback về tiếng gõ cửa
          playKnockSound();
        };
        
        // PHÁT NGAY LẬP TỨC
        console.log('🎯 Đang phát âm thanh...');
        speechSynthesis.speak(utterance);
        
        // Fallback nếu không phát được sau 2 giây
        setTimeout(() => {
          if (!speechSynthesis.speaking) {
            console.log('⚠️ Speech synthesis không hoạt động, chuyển sang tiếng gõ cửa');
            playKnockSound();
          }
        }, 2000);
        
      } catch (error) {
        console.log('❌ Không thể phát thông báo giọng nói:', error);
        // Fallback về tiếng gõ cửa nếu không thể phát giọng nói
        playKnockSound();
      }
    }
    
    // Hàm hiển thị banner thông báo trên màn hình
    function showAnnouncementBanner(message) {
      // Xóa banner cũ nếu có
      const existingBanner = document.getElementById('announcementBanner');
      if (existingBanner) {
        existingBanner.remove();
      }
      
      // Tạo banner mới
      const banner = document.createElement('div');
      banner.id = 'announcementBanner';
      banner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
        text-align: center;
        padding: 20px;
        font-size: 24px;
        font-weight: bold;
        z-index: 9999;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        animation: slideDown 0.5s ease-out;
      `;
      banner.innerHTML = `🔊 ${message}`;
      
      // Thêm CSS animation
      if (!document.getElementById('bannerStyles')) {
        const style = document.createElement('style');
        style.id = 'bannerStyles';
        style.textContent = `
          @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
          }
          @keyframes slideUp {
            from { transform: translateY(0); }
            to { transform: translateY(-100%); }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(banner);
      
      // Tự động ẩn sau 5 giây
      setTimeout(() => {
        if (banner.parentNode) {
          banner.style.animation = 'slideUp 0.5s ease-out';
          setTimeout(() => banner.remove(), 500);
        }
      }, 5000);
    }

    // Hàm test âm thanh (giữ lại để có thể gọi từ console nếu cần)
    function testAnnouncement() {
      console.log('🧪 Test âm thanh...');
      announceNumber('1001', '1', false);
    }
    
    // Hàm test gọi lại (giữ lại để có thể gọi từ console nếu cần)
    function testRecallAnnouncement() {
      console.log('🧪 Test gọi lại...');
      announceNumber('1001', '1', true);
    }
    
    // Hàm hỗ trợ thiết lập giọng nói tiếng Việt (ưu tiên giọng nữ)
    function setVietnameseVoice(utterance, message) {
      // Dừng tất cả giọng nói trước đó ngay lập tức
      speechSynthesis.cancel();
      
      const voices = speechSynthesis.getVoices();
      console.log('Danh sách tất cả giọng nói có sẵn:');
      voices.forEach((voice, index) => {
        console.log(`${index}: ${voice.name} (${voice.lang}) - ${voice.localService ? 'Local' : 'Remote'} - Gender: ${voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('woman') || voice.name.toLowerCase().includes('mai') || voice.name.toLowerCase().includes('linh') || voice.name.toLowerCase().includes('yen') ? 'Female' : 'Unknown'}`);
      });
      
      // Lọc chỉ lấy giọng nói tiếng Việt một cách chặt chẽ
      const vietnameseVoices = voices.filter(voice => {
        const lang = voice.lang.toLowerCase();
        const name = voice.name.toLowerCase();
        
        return (
          lang === 'vi-vn' || 
          lang === 'vi' ||
          lang.includes('vi-vn') ||
          name.includes('vietnam') ||
          name.includes('việt') ||
          name.includes('mai') ||
          name.includes('linh') ||
          name.includes('yen') ||
          name.includes('hương')
        );
      });
      
      console.log('🇻🇳 Chỉ giọng nói tiếng Việt:', vietnameseVoices);
      
      // Thử tìm giọng nữ tiếng Việt theo thứ tự ưu tiên
      let selectedVoice = null;
      
      // 1. Ưu tiên cao nhất: Giọng nữ Microsoft Mai/Linh
      selectedVoice = vietnameseVoices.find(voice => {
        const name = voice.name.toLowerCase();
        return (
          name.includes('mai') ||
          name.includes('linh') ||
          name.includes('yen') ||
          name.includes('hương') ||
          name.includes('lan')
        );
      });
      
      // 2. Tìm giọng nữ tiếng Việt khác
      if (!selectedVoice) {
        selectedVoice = vietnameseVoices.find(voice => {
          const name = voice.name.toLowerCase();
          return (
            name.includes('female') ||
            name.includes('woman') ||
            name.includes('nữ')
          );
        });
      }
      
      // 3. Chấp nhận BẤT KỲ giọng tiếng Việt nào
      if (!selectedVoice && vietnameseVoices.length > 0) {
        selectedVoice = vietnameseVoices[0];
        console.log('⚠️ Sử dụng giọng Việt có sẵn:', selectedVoice.name);
      }
      
      // QUAN TRỌNG: Chỉ tiếp tục nếu có giọng tiếng Việt
      if (!selectedVoice) {
        console.log('❌ KHÔNG TÌM THẤY GIỌNG TIẾNG VIỆT - HỦY THÔNG BÁO');
        return; // Dừng lại nếu không có giọng tiếng Việt
      }
      
      // Thiết lập giọng nói
      utterance.voice = selectedVoice;
      console.log('✅ ĐÃ CHỌN GIỌNG TIẾNG VIỆT:', selectedVoice.name, '(' + selectedVoice.lang + ')');
      
      // FORCE SET ngôn ngữ tiếng Việt 100%
      utterance.lang = 'vi-VN';
      
      // Thiết lập tham số âm thanh tối ưu
      utterance.rate = 0.6; // Tăng nhẹ tốc độ để tự nhiên hơn
      utterance.pitch = 1.0; // Giữ âm điệu tự nhiên
      utterance.volume = 1.0; // Âm lượng tối đa
      
      // Event listeners với thông báo rõ ràng
      utterance.onstart = () => console.log('🔊 BẮT ĐẦU PHÁT ÂM TIẾNG VIỆT:', selectedVoice.name);
      utterance.onend = () => console.log('✅ HOÀN THÀNH PHÁT ÂM TIẾNG VIỆT');
      utterance.onerror = (e) => console.log('❌ LỖI PHÁT ÂM:', e.error);
      
      // ĐẢM BẢO CHỈ PHÁT TIẾNG VIỆT 100%
      speechSynthesis.cancel(); // Dừng tất cả
      
      // Kiểm tra cuối cùng và phát
      setTimeout(() => {
        // Triple check giọng nói
        if (utterance.voice && 
            utterance.voice.lang && 
            utterance.voice.lang.toLowerCase().includes('vi')) {
          
          console.log('🎯 XÁC NHẬN CUỐI: Phát giọng', utterance.voice.name, '- Ngôn ngữ:', utterance.voice.lang);
          speechSynthesis.speak(utterance);
          
        } else {
          console.log('❌ TỪNG CHỐI: Không phải tiếng Việt, hủy phát âm');
          // Fallback về tiếng gõ cửa
          playKnockSound();
        }
      }, 150); // Delay 150ms để ổn định
      
      console.log('📢 Đã gửi lệnh phát thông báo với giọng:', selectedVoice ? selectedVoice.name : 'Mặc định');
    }

    // Mapping lĩnh vực sang số quầy
    const serviceToCounter = {
      "Chứng thực - Hộ tịch": "1",
      "Văn thư": "2",
      "Nội vụ - GDĐT - Văn hóa - Khoa học và Thông tin - Y tế - Lao động - Bảo trợ Xã hội": "3",
      "Nông nghiệp và Môi trường - Tài chính Kế hoạch - Xây dựng và Công thương": "4"
    };

    // Biến theo dõi lệnh gọi gần nhất để phát âm thanh
    let lastKnownCalls = {};

    // Hàm kiểm tra và phát âm thanh cho lệnh gọi mới
    function checkForNewCalls() {
  fetch('https://hcctrile.onrender.com/latest-calls')
        .then(res => res.json())
        .then(latestCalls => {
          console.log('📡 Kiểm tra lệnh gọi mới:', latestCalls);
          
          for (const service in latestCalls) {
            const latestCall = latestCalls[service];
            if (latestCall && latestCall.number) {
              const lastKnown = lastKnownCalls[service];
              
              console.log(`🔍 Service: ${service}`);
              console.log(`   Latest call:`, latestCall);
              console.log(`   Last known:`, lastKnown);
              
              // Kiểm tra xem có lệnh gọi mới không
              if (!lastKnown || 
                  lastKnown.number !== latestCall.number || 
                  lastKnown.time !== latestCall.time) {
                
                console.log(`🆕 Phát hiện lệnh gọi mới cho ${service}!`);
                
                // Phát âm thanh cho lệnh gọi mới
                const counterNumber = serviceToCounter[service];
                if (counterNumber) {
                  console.log(`🔔 Phát thông báo cho lệnh gọi mới: ${latestCall.number} - Quầy ${counterNumber}${latestCall.isRecall ? ' (Gọi lại)' : ''}`);
                  announceNumber(latestCall.number, counterNumber, latestCall.isRecall || false);
                } else {
                  console.log(`❌ Không tìm thấy counter number cho service: ${service}`);
                }
                
                // Cập nhật theo dõi
                lastKnownCalls[service] = {
                  number: latestCall.number,
                  time: latestCall.time
                };
              } else {
                console.log(`✅ Không có lệnh gọi mới cho ${service}`);
              }
            } else {
              console.log(`⚪ Không có lệnh gọi nào cho ${service}`);
            }
          }
        })
        .catch(error => {
          console.error('❌ Lỗi khi kiểm tra lệnh gọi mới:', error);
        });
    }

    function updateCurrentTime() {
      const now = new Date();
      
      // Cập nhật giờ
      const timeHour = now.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('timeHour').textContent = timeHour;
      
      // Cập nhật ngày tháng năm
      const timeDate = now.toLocaleDateString('vi-VN', {
        weekday: 'long',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      document.getElementById('timeDate').textContent = timeDate;
    }

    function formatTime(timeString) {
      const date = new Date(timeString);
      return date.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function formatDate(timeString) {
      const date = new Date(timeString);
      return date.toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function createCounterCard(counter) {
      const hasCurrentCall = counter.currentCalling !== null;
      const cardClass = hasCurrentCall ? 'counter-card active' : 'counter-card';
      
      return `
        <div class="${cardClass}" data-service="${counter.service}">
          <div class="counter-header">
            <div class="counter-number">QUẦY ${counter.counterNumber}</div>
          </div>
          
          <div class="current-calling">
            <div class="calling-label">Đang gọi</div>
            <div class="calling-display">
              ${hasCurrentCall ? `
                <div class="calling-number">${counter.currentCalling.number}</div>
                <div class="calling-time">Gọi lúc: ${formatDate(counter.currentCalling.time)}</div>
              ` : `
                <div class="no-calling">Chưa có</div>
              `}
            </div>
          </div>
          
          <div class="waiting-info">
            <span class="waiting-count">Khách đang chờ:</span>
            <span class="waiting-number">${counter.waitingCount}</span>
          </div>
        </div>
      `;
    }

    function updateCounterCard(card, counter) {
      const hasCurrentCall = counter.currentCalling !== null;
      const oldData = currentCountersData[counter.service];
      
      // Kiểm tra xem có số mới được gọi không
      const isNewCall = hasCurrentCall && (!oldData || 
        !oldData.currentCalling || 
        oldData.currentCalling.number !== counter.currentCalling.number);
      
      // Cập nhật class cho card
      if (hasCurrentCall && !card.classList.contains('active')) {
        card.classList.add('active');
      } else if (!hasCurrentCall && card.classList.contains('active')) {
        card.classList.remove('active');
      }
      
      // Cập nhật nội dung calling display
      const callingDisplay = card.querySelector('.calling-display');
      const newCallingContent = hasCurrentCall ? `
        <div class="calling-number">${counter.currentCalling.number}</div>
        <div class="calling-time">Gọi lúc: ${formatDate(counter.currentCalling.time)}</div>
      ` : `
        <div class="no-calling">Chưa có</div>
      `;
      
      if (callingDisplay.innerHTML.trim() !== newCallingContent.trim()) {
        callingDisplay.style.opacity = '0.5';
        setTimeout(() => {
          callingDisplay.innerHTML = newCallingContent;
          callingDisplay.style.opacity = '1';
        }, 150);
      }
      
      // Cập nhật số khách chờ
      const waitingNumber = card.querySelector('.waiting-number');
      if (waitingNumber.textContent !== counter.waitingCount.toString()) {
        waitingNumber.style.transform = 'scale(1.2)';
        waitingNumber.textContent = counter.waitingCount;
        
        // Animation cho số thay đổi
        waitingNumber.classList.add('highlight');
        setTimeout(() => {
          waitingNumber.style.transform = 'scale(1)';
          waitingNumber.classList.remove('highlight');
        }, 600);
      }
      
      // Hiệu ứng cho cuộc gọi mới
      if (isNewCall) {
        console.log('🆕 Số mới được gọi:', counter.currentCalling.number, 'tại quầy', counter.counterNumber);
        
        // Chú ý: Không phát thông báo ở đây vì đã có checkForNewCalls() xử lý
        // announceNumber(counter.currentCalling.number, counter.counterNumber);
        
        // Animation cho card
        card.style.animation = 'newCall 2s ease-in-out';
        setTimeout(() => {
          card.style.animation = '';
        }, 2000);
        
        // Visual feedback
        const callingNumberElement = card.querySelector('.calling-number');
        if (callingNumberElement) {
          callingNumberElement.style.animation = 'pulse 1s ease-in-out 3';
          setTimeout(() => {
            callingNumberElement.style.animation = '';
          }, 3000);
        }
      }
    }

    async function loadCountersStatus() {
      try {
  const response = await fetch('https://hcctrile.onrender.com/all-counters-status');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('📊 Dữ liệu quầy nhận được:', data);
        
        const grid = document.getElementById('countersGrid');
        
        // Xử lý dữ liệu cho từng quầy
        data.counters.forEach(counter => {
          let card = grid.querySelector(`[data-service="${counter.service}"]`);
          
          if (!card) {
            // Tạo card mới nếu chưa có
            grid.innerHTML += createCounterCard(counter);
            card = grid.querySelector(`[data-service="${counter.service}"]`);
            card.classList.add('refresh-animation');
          } else {
            // Cập nhật card hiện có
            updateCounterCard(card, counter);
          }
        });
        
        // Lưu dữ liệu hiện tại để so sánh lần sau
        currentCountersData = {};
        data.counters.forEach(counter => {
          currentCountersData[counter.service] = counter;
        });
        
        lastUpdateTime = Date.now();
        
      } catch (error) {
        console.error('❌ Lỗi khi tải dữ liệu quầy:', error);
        
        // Thử lại sau 3 giây
        setTimeout(() => {
          loadCountersStatus();
        }, 3000);
      }
    }

    // Khởi tạo
    function init() {
      console.log('🚀 Khởi tạo màn hình hiển thị tất cả quầy');
      
      // Cập nhật thời gian ngay lập tức
      updateCurrentTime();
      
      // Tải dữ liệu quầy ngay lập tức
      loadCountersStatus();
      
      // Thiết lập các interval
      setInterval(updateCurrentTime, 1000);
      setInterval(loadCountersStatus, 3000); // Cập nhật mỗi 3 giây
      setInterval(checkForNewCalls, 2000); // Kiểm tra lệnh gọi mới mỗi 2 giây
      
      console.log('✅ Khởi tạo hoàn tất');
    }

    // Khởi tạo khi trang web load xong
    document.addEventListener('DOMContentLoaded', init);

    // Xử lý focus/blur để tối ưu hiệu suất
    let isPageVisible = true;
    let refreshInterval;

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        isPageVisible = false;
        console.log('📱 Trang web bị ẩn - Giảm tần suất cập nhật');
        clearInterval(refreshInterval);
        refreshInterval = setInterval(loadCountersStatus, 10000); // 10 giây khi ẩn
      } else {
        isPageVisible = true;
        console.log('📱 Trang web được hiển thị - Khôi phục tần suất cập nhật');
        clearInterval(refreshInterval);
        refreshInterval = setInterval(loadCountersStatus, 3000); // 3 giây khi hiển thị
        
        // Cập nhật ngay lập tức khi có thông báo
        setTimeout(loadCountersStatus, 500);
      }
    });
  </script>
</body>
</html>
