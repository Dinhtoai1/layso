<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tr·∫°ng th√°i t·∫•t c·∫£ qu·∫ßy d·ªãch v·ª•</title>
  <style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    height: 100vh;
    max-height: 100vh;
    overflow: hidden;
    padding: 0;
    margin: 0;
    color: #333;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(255,255,255,0.08) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }
  .container {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 1vh;
    position: relative;
    z-index: 1;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255,255,255,0.12);
    backdrop-filter: blur(25px);
    border: 1px solid rgba(255,255,255,0.25);
    padding: 2vh 4vh;
    border-radius: 20px;
    box-shadow: 
      0 10px 40px rgba(0,0,0,0.15),
      inset 0 1px 0 rgba(255,255,255,0.25);
    flex-shrink: 0;
    position: relative;
    height: 14vh;
  }
  .logo-section {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .logo-section img {
    width: 60vh;
    height: 12vh;
    object-fit: contain;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    border-radius: 12px;
  }
  .time {
    position: absolute;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5vh;
  }
  .time-hour {
    font-size: 3.2vh;
    font-weight: 700;
    color: #00ff88;
    text-shadow: 0 0 10px rgba(0, 255, 136, 0.5), 0 2px 4px rgba(0,0,0,0.5);
    letter-spacing: 1px;
  }
  .time-date {
    font-size: 1.6vh;
    font-weight: 500;
    color: rgba(255,255,255,0.9);
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    white-space: nowrap;
  }
  .counters-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: 1fr;
    gap: 2vh;
    flex: 1;
    height: calc(100vh - 14vh);
    padding: 2vh 3vh;
    justify-content: center;
    align-content: center;
    max-width: 100%;
    margin: 0 auto;
    place-items: stretch;
  }
  .counter-card {
    background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
    backdrop-filter: blur(30px);
    border: 2px solid rgba(255,255,255,0.2);
    padding: 1.8vh;
    border-radius: 20px;
    box-shadow: 
      0 12px 40px rgba(0,0,0,0.18),
      inset 0 2px 0 rgba(255,255,255,0.3);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-left: 0.6vh solid rgba(255,255,255,0.5);
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
    position: relative;
    aspect-ratio: 3/4;
  }
  .counter-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }
  .counter-card.active {
    border-left-color: #00ff88;
    background: linear-gradient(145deg, rgba(0, 255, 136, 0.2), rgba(0, 255, 136, 0.1));
    transform: translateY(-3px) scale(1.01);
    box-shadow: 
      0 20px 60px rgba(0, 255, 136, 0.3),
      inset 0 2px 0 rgba(255,255,255,0.4);
  }
  .counter-card:hover {
    transform: translateY(-2px) scale(1.005);
    box-shadow: 0 15px 50px rgba(0,0,0,0.22);
  }
  .counter-header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 1.5vh;
    padding-bottom: 1vh;
    border-bottom: 2px solid rgba(255,255,255,0.3);
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }
  .counter-number {
    font-size: 3vh;
    font-weight: 900;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 0.8vh 1.8vh;
    border-radius: 15px;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    flex-shrink: 0;
    border: 2px solid rgba(255,255,255,0.3);
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    letter-spacing: 0.5px;
  }
  .service-name {
    display: none;
  }
  .current-calling {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.08));
    backdrop-filter: blur(15px);
    padding: 2vh 1.5vh;
    border-radius: 15px;
    margin-bottom: 1vh;
    border: 1.5px solid rgba(255, 255, 255, 0.3);
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    position: relative;
    z-index: 1;
  }
  .calling-label {
    font-size: 1.4vh;
    color: rgba(255,255,255,0.9);
    margin-bottom: 0.8vh;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.4);
  }
  .calling-number {
    font-size: 4.5vh;
    font-weight: 900;
    color: #00ff88;
    margin-bottom: 0.8vh;
    text-shadow: 
      0 0 15px rgba(0, 255, 136, 0.6),
      0 3px 6px rgba(0,0,0,0.5);
    text-align: center;
    letter-spacing: 1.5px;
  }
  .calling-time {
    font-size: 1.1vh;
    color: rgba(255,255,255,0.8);
    font-style: italic;
    text-align: center;
    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    font-weight: 500;
  }
  .no-calling {
    font-size: 2vh;
    color: rgba(255,255,255,0.6);
    text-align: center;
    font-style: italic;
    padding: 1.5vh 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.4);
    font-weight: 600;
  }
  .waiting-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5vh 2vh;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
    backdrop-filter: blur(20px);
    border-radius: 18px;
    border: 2px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }
  .waiting-count {
    font-size: 1.8vh;
    font-weight: 700;
    color: #ffffff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    letter-spacing: 0.5px;
  }
  .waiting-number {
    font-size: 2.5vh;
    font-weight: 900;
    color: #ff4757;
    background: rgba(255, 255, 255, 0.95);
    padding: 0.8vh 1.5vh;
    border-radius: 25px;
    box-shadow: 
      0 6px 20px rgba(0,0,0,0.25),
      inset 0 2px 4px rgba(255, 71, 87, 0.2);
    min-width: 3.5vh;
    text-align: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid rgba(255,71,87,0.4);
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  .waiting-number.highlight {
    animation: bounceGlow 0.8s ease;
    background: #ff9500;
    color: white;
    transform: scale(1.1);
    box-shadow: 
      0 8px 30px rgba(255, 149, 0, 0.5),
      inset 0 2px 4px rgba(255, 149, 0, 0.3);
  }
  .calling-display {
    transition: all 0.4s ease;
  }
  
  @keyframes bounceGlow {
    0%, 100% { transform: scale(1); }
    25% { transform: scale(1.2); box-shadow: 0 0 30px rgba(255, 149, 0, 0.8); }
    50% { transform: scale(1.1); }
    75% { transform: scale(1.15); }
  }
  
  /* T·ªëi ∆∞u ƒë·∫∑c bi·ªát cho m√†n h√¨nh 16:9 */
  @media screen and (aspect-ratio: 16/9) {
    .header {
      padding: 1.8vh 3vh;
    }
    .logo-section img {
      width: 36vh;
      height: 11vh;
    }
    .time {
      font-size: 2vh;
      bottom: -1.2vh;
    }
    .counters-grid {
      gap: 2.5vh;
      padding: 2.5vh 3vh;
      height: calc(100vh - 13vh);
    }
    .counter-card {
      padding: 2vh;
    }
    .calling-number {
      font-size: 5vh;
    }
    .counter-number {
      font-size: 3.5vh;
    }
  }
  
  @media screen and (min-width: 1280px) and (max-width: 1920px) and (min-height: 720px) and (max-height: 1080px) {
    .header {
      padding: 2vh 3vh;
    }
    .logo-section img {
      width: 38vh;
      height: 11.5vh;
    }
    .time {
      font-size: 2.1vh;
    }
    .counters-grid {
      gap: 2.8vh;
      max-width: 1350px;
    }
    .counter-card {
      padding: 2.2vh;
    }
  }
  @keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.08); opacity: 0.9; }
    100% { transform: scale(1); opacity: 1; }
  }
  @keyframes newCall {
    0% { transform: scale(1) translateY(-5px); background-color: transparent; }
    25% { transform: scale(1.03) translateY(-8px); background-color: rgba(0, 255, 136, 0.2); }
    50% { transform: scale(1.02) translateY(-6px); background-color: rgba(0, 255, 136, 0.3); }
    75% { transform: scale(1.01) translateY(-5px); background-color: rgba(0, 255, 136, 0.1); }
    100% { transform: scale(1.02) translateY(-5px); background-color: transparent; }
  }
  .refresh-animation {
    animation: fadeInUp 0.6s ease-out;
  }
  @keyframes fadeInUp {
    0% { opacity: 0; transform: translateY(30px) scale(0.95); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }
  @keyframes bounce {
    0%, 20%, 60%, 100% { transform: translateY(0); }
    40% { transform: translateY(-15px); }
    80% { transform: translateY(-8px); }
  }
  @media (max-width: 768px) {
    .header {
      padding: 2vh 2vh;
      flex-direction: column;
      gap: 1.5vh;
      height: auto;
    }
    .logo-section {
      position: relative;
      left: auto;
      top: auto;
      transform: none;
    }
    .logo-section img {
      width: 32vh;
      height: 10vh;
    }
    .time {
      position: relative;
      right: auto;
      top: auto;
      transform: none;
      align-items: center;
    }
    .time-hour {
      font-size: 2.2vh;
    }
    .time-date {
      font-size: 1.2vh;
    }
    .counters-grid {
      grid-template-columns: 1fr;
      gap: 2vh;
      padding: 2vh 1.5vh;
      height: calc(100vh - 12vh);
    }
    .calling-number {
      font-size: 4.5vh;
    }
    .counter-number {
      font-size: 3vh;
      padding: 1vh 2vh;
    }
    .counter-card {
      padding: 2vh 1.5vh;
    }
  }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-section">
        <img src="logo.png" alt="Logo Trung t√¢m">
      </div>
      <div class="time" id="currentTime">
        <div class="time-hour" id="timeHour"></div>
        <div class="time-date" id="timeDate"></div>
      </div>
    </div>

    <div class="counters-grid" id="countersGrid">
      <!-- C√°c th·∫ª qu·∫ßy s·∫Ω ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·∫±ng JavaScript -->
    </div>
  </div>

  <script>
    let lastUpdateTime = null;
    let currentCountersData = {};
    let lastAnnouncementKey = null; // Theo d√µi th√¥ng b√°o g·∫ßn nh·∫•t ƒë·ªÉ tr√°nh l·∫∑p

    // H√†m ph√°t √¢m thanh ƒë∆°n gi·∫£n nh∆∞ ti·∫øng g√µ c·ª≠a
    function playKnockSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // T·∫°o 3 ti·∫øng "g√µ" li√™n ti·∫øp
        const times = [0, 0.15, 0.3];
        
        times.forEach(startTime => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          // T·∫ßn s·ªë th·∫•p gi·ªëng ti·∫øng g√µ c·ª≠a
          oscillator.frequency.setValueAtTime(150, audioContext.currentTime + startTime);
          oscillator.frequency.exponentialRampToValueAtTime(80, audioContext.currentTime + startTime + 0.1);
          
          // √Çm l∆∞·ª£ng nhanh l√™n r·ªìi nhanh xu·ªëng
          gainNode.gain.setValueAtTime(0, audioContext.currentTime + startTime);
          gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + startTime + 0.02);
          gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + startTime + 0.1);
          
          oscillator.start(audioContext.currentTime + startTime);
          oscillator.stop(audioContext.currentTime + startTime + 0.1);
        });
      } catch (error) {
        console.log('Kh√¥ng th·ªÉ ph√°t √¢m thanh:', error);
      }
    }

    // H√†m th√¥ng b√°o b·∫±ng gi·ªçng n√≥i ti·∫øng Vi·ªát v·ªõi kho·∫£ng c√°ch r√µ r√†ng
    function announceNumber(number, counterNumber, isRecall = false) {
      try {
        console.log(`üé§ announceNumber ƒë∆∞·ª£c g·ªçi: s·ªë ${number}, qu·∫ßy ${counterNumber}${isRecall ? ' (G·ªçi l·∫°i)' : ''}`);
        
        // FORCE CLEAR t·∫•t c·∫£ speech tr∆∞·ªõc ƒë√≥
        speechSynthesis.cancel();
        
        // T·∫°o c√¢u th√¥ng b√°o v·ªõi ng·∫Øt qu√£ng r√µ r√†ng
        const message = isRecall 
          ? `G·ªçi l·∫°i, xin k√≠nh m·ªùi qu√Ω kh√°ch c√≥ s·ªë th·ª© t·ª± ${number} ƒë·∫øn qu·∫ßy s·ªë ${counterNumber} ƒë·ªÉ th·ª±c hi·ªán th·ªß t·ª•c h√†nh ch√≠nh`
          : `Xin k√≠nh m·ªùi qu√Ω kh√°ch c√≥ s·ªë th·ª© t·ª± ${number} ƒë·∫øn qu·∫ßy s·ªë ${counterNumber} ƒë·ªÉ th·ª±c hi·ªán th·ªß t·ª•c h√†nh ch√≠nh`;
        
        console.log('üì¢ B·∫Øt ƒë·∫ßu ph√°t th√¥ng b√°o:', message);
        
        // T·∫°o utterance
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.lang = 'vi-VN';
        utterance.rate = 0.7;
        utterance.pitch = 1.1;
        utterance.volume = 1.0;
        
        // T√¨m gi·ªçng ti·∫øng Vi·ªát t·ªët nh·∫•t
        const voices = speechSynthesis.getVoices();
        console.log(`ÔøΩ C√≥ ${voices.length} gi·ªçng n√≥i c√≥ s·∫µn`);
        
        // Th·ª≠ t√¨m gi·ªçng Vi·ªát
        let vietnameseVoice = voices.find(voice => 
          voice.lang === 'vi-VN' || 
          voice.lang === 'vi' ||
          voice.name.toLowerCase().includes('mai') ||
          voice.name.toLowerCase().includes('linh') ||
          voice.name.toLowerCase().includes('vietnam')
        );
        
        if (vietnameseVoice) {
          utterance.voice = vietnameseVoice;
          console.log(`‚úÖ S·ª≠ d·ª•ng gi·ªçng Vi·ªát: ${vietnameseVoice.name} (${vietnameseVoice.lang})`);
        } else {
          console.log('‚ö†Ô∏è Kh√¥ng c√≥ gi·ªçng Vi·ªát, s·ª≠ d·ª•ng gi·ªçng m·∫∑c ƒë·ªãnh');
        }
        
        // Event listeners
        utterance.onstart = () => {
          console.log('ÔøΩ B·∫ÆT ƒê·∫¶U PH√ÅT √ÇM THANH');
          // Hi·ªÉn th·ªã th√¥ng b√°o tr√™n m√†n h√¨nh
          showAnnouncementBanner(message);
        };
        
        utterance.onend = () => {
          console.log('‚úÖ HO√ÄN TH√ÄNH PH√ÅT √ÇM THANH');
        };
        
        utterance.onerror = (e) => {
          console.log('‚ùå L·ªñI PH√ÅT √ÇM:', e.error);
          // Fallback v·ªÅ ti·∫øng g√µ c·ª≠a
          playKnockSound();
        };
        
        // PH√ÅT NGAY L·∫¨P T·ª®C
        console.log('üéØ ƒêang ph√°t √¢m thanh...');
        speechSynthesis.speak(utterance);
        
        // Fallback n·∫øu kh√¥ng ph√°t ƒë∆∞·ª£c sau 2 gi√¢y
        setTimeout(() => {
          if (!speechSynthesis.speaking) {
            console.log('‚ö†Ô∏è Speech synthesis kh√¥ng ho·∫°t ƒë·ªông, chuy·ªÉn sang ti·∫øng g√µ c·ª≠a');
            playKnockSound();
          }
        }, 2000);
        
      } catch (error) {
        console.log('‚ùå Kh√¥ng th·ªÉ ph√°t th√¥ng b√°o gi·ªçng n√≥i:', error);
        // Fallback v·ªÅ ti·∫øng g√µ c·ª≠a n·∫øu kh√¥ng th·ªÉ ph√°t gi·ªçng n√≥i
        playKnockSound();
      }
    }
    
    // H√†m hi·ªÉn th·ªã banner th√¥ng b√°o tr√™n m√†n h√¨nh
    function showAnnouncementBanner(message) {
      // X√≥a banner c≈© n·∫øu c√≥
      const existingBanner = document.getElementById('announcementBanner');
      if (existingBanner) {
        existingBanner.remove();
      }
      
      // T·∫°o banner m·ªõi
      const banner = document.createElement('div');
      banner.id = 'announcementBanner';
      banner.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        color: white;
        text-align: center;
        padding: 20px;
        font-size: 24px;
        font-weight: bold;
        z-index: 9999;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        animation: slideDown 0.5s ease-out;
      `;
      banner.innerHTML = `üîä ${message}`;
      
      // Th√™m CSS animation
      if (!document.getElementById('bannerStyles')) {
        const style = document.createElement('style');
        style.id = 'bannerStyles';
        style.textContent = `
          @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
          }
          @keyframes slideUp {
            from { transform: translateY(0); }
            to { transform: translateY(-100%); }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(banner);
      
      // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
      setTimeout(() => {
        if (banner.parentNode) {
          banner.style.animation = 'slideUp 0.5s ease-out';
          setTimeout(() => banner.remove(), 500);
        }
      }, 5000);
    }

    // H√†m test √¢m thanh (gi·ªØ l·∫°i ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ console n·∫øu c·∫ßn)
    function testAnnouncement() {
      console.log('üß™ Test √¢m thanh...');
      announceNumber('1001', '1', false);
    }
    
    // H√†m test g·ªçi l·∫°i (gi·ªØ l·∫°i ƒë·ªÉ c√≥ th·ªÉ g·ªçi t·ª´ console n·∫øu c·∫ßn)
    function testRecallAnnouncement() {
      console.log('üß™ Test g·ªçi l·∫°i...');
      announceNumber('1001', '1', true);
    }
    
    // H√†m h·ªó tr·ª£ thi·∫øt l·∫≠p gi·ªçng n√≥i ti·∫øng Vi·ªát (∆∞u ti√™n gi·ªçng n·ªØ)
    function setVietnameseVoice(utterance, message) {
      // D·ª´ng t·∫•t c·∫£ gi·ªçng n√≥i tr∆∞·ªõc ƒë√≥ ngay l·∫≠p t·ª©c
      speechSynthesis.cancel();
      
      const voices = speechSynthesis.getVoices();
      console.log('Danh s√°ch t·∫•t c·∫£ gi·ªçng n√≥i c√≥ s·∫µn:');
      voices.forEach((voice, index) => {
        console.log(`${index}: ${voice.name} (${voice.lang}) - ${voice.localService ? 'Local' : 'Remote'} - Gender: ${voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('woman') || voice.name.toLowerCase().includes('mai') || voice.name.toLowerCase().includes('linh') || voice.name.toLowerCase().includes('yen') ? 'Female' : 'Unknown'}`);
      });
      
      // L·ªçc ch·ªâ l·∫•y gi·ªçng n√≥i ti·∫øng Vi·ªát m·ªôt c√°ch ch·∫∑t ch·∫Ω
      const vietnameseVoices = voices.filter(voice => {
        const lang = voice.lang.toLowerCase();
        const name = voice.name.toLowerCase();
        
        return (
          lang === 'vi-vn' || 
          lang === 'vi' ||
          lang.includes('vi-vn') ||
          name.includes('vietnam') ||
          name.includes('vi·ªát') ||
          name.includes('mai') ||
          name.includes('linh') ||
          name.includes('yen') ||
          name.includes('h∆∞∆°ng')
        );
      });
      
      console.log('üáªüá≥ Ch·ªâ gi·ªçng n√≥i ti·∫øng Vi·ªát:', vietnameseVoices);
      
      // Th·ª≠ t√¨m gi·ªçng n·ªØ ti·∫øng Vi·ªát theo th·ª© t·ª± ∆∞u ti√™n
      let selectedVoice = null;
      
      // 1. ∆Øu ti√™n cao nh·∫•t: Gi·ªçng n·ªØ Microsoft Mai/Linh
      selectedVoice = vietnameseVoices.find(voice => {
        const name = voice.name.toLowerCase();
        return (
          name.includes('mai') ||
          name.includes('linh') ||
          name.includes('yen') ||
          name.includes('h∆∞∆°ng') ||
          name.includes('lan')
        );
      });
      
      // 2. T√¨m gi·ªçng n·ªØ ti·∫øng Vi·ªát kh√°c
      if (!selectedVoice) {
        selectedVoice = vietnameseVoices.find(voice => {
          const name = voice.name.toLowerCase();
          return (
            name.includes('female') ||
            name.includes('woman') ||
            name.includes('n·ªØ')
          );
        });
      }
      
      // 3. Ch·∫•p nh·∫≠n B·∫§T K·ª≤ gi·ªçng ti·∫øng Vi·ªát n√†o
      if (!selectedVoice && vietnameseVoices.length > 0) {
        selectedVoice = vietnameseVoices[0];
        console.log('‚ö†Ô∏è S·ª≠ d·ª•ng gi·ªçng Vi·ªát c√≥ s·∫µn:', selectedVoice.name);
      }
      
      // QUAN TR·ªåNG: Ch·ªâ ti·∫øp t·ª•c n·∫øu c√≥ gi·ªçng ti·∫øng Vi·ªát
      if (!selectedVoice) {
        console.log('‚ùå KH√îNG T√åM TH·∫§Y GI·ªåNG TI·∫æNG VI·ªÜT - H·ª¶Y TH√îNG B√ÅO');
        return; // D·ª´ng l·∫°i n·∫øu kh√¥ng c√≥ gi·ªçng ti·∫øng Vi·ªát
      }
      
      // Thi·∫øt l·∫≠p gi·ªçng n√≥i
      utterance.voice = selectedVoice;
      console.log('‚úÖ ƒê√É CH·ªåN GI·ªåNG TI·∫æNG VI·ªÜT:', selectedVoice.name, '(' + selectedVoice.lang + ')');
      
      // FORCE SET ng√¥n ng·ªØ ti·∫øng Vi·ªát 100%
      utterance.lang = 'vi-VN';
      
      // Thi·∫øt l·∫≠p tham s·ªë √¢m thanh t·ªëi ∆∞u
      utterance.rate = 0.6; // TƒÉng nh·∫π t·ªëc ƒë·ªô ƒë·ªÉ t·ª± nhi√™n h∆°n
      utterance.pitch = 1.0; // Gi·ªØ √¢m ƒëi·ªáu t·ª± nhi√™n
      utterance.volume = 1.0; // √Çm l∆∞·ª£ng t·ªëi ƒëa
      
      // Event listeners v·ªõi th√¥ng b√°o r√µ r√†ng
      utterance.onstart = () => console.log('üîä B·∫ÆT ƒê·∫¶U PH√ÅT √ÇM TI·∫æNG VI·ªÜT:', selectedVoice.name);
      utterance.onend = () => console.log('‚úÖ HO√ÄN TH√ÄNH PH√ÅT √ÇM TI·∫æNG VI·ªÜT');
      utterance.onerror = (e) => console.log('‚ùå L·ªñI PH√ÅT √ÇM:', e.error);
      
      // ƒê·∫¢M B·∫¢O CH·ªà PH√ÅT TI·∫æNG VI·ªÜT 100%
      speechSynthesis.cancel(); // D·ª´ng t·∫•t c·∫£
      
      // Ki·ªÉm tra cu·ªëi c√πng v√† ph√°t
      setTimeout(() => {
        // Triple check gi·ªçng n√≥i
        if (utterance.voice && 
            utterance.voice.lang && 
            utterance.voice.lang.toLowerCase().includes('vi')) {
          
          console.log('üéØ X√ÅC NH·∫¨N CU·ªêI: Ph√°t gi·ªçng', utterance.voice.name, '- Ng√¥n ng·ªØ:', utterance.voice.lang);
          speechSynthesis.speak(utterance);
          
        } else {
          console.log('‚ùå T·ª™NG CH·ªêI: Kh√¥ng ph·∫£i ti·∫øng Vi·ªát, h·ªßy ph√°t √¢m');
          // Fallback v·ªÅ ti·∫øng g√µ c·ª≠a
          playKnockSound();
        }
      }, 150); // Delay 150ms ƒë·ªÉ ·ªïn ƒë·ªãnh
      
      console.log('üì¢ ƒê√£ g·ª≠i l·ªánh ph√°t th√¥ng b√°o v·ªõi gi·ªçng:', selectedVoice ? selectedVoice.name : 'M·∫∑c ƒë·ªãnh');
    }

    // Mapping lƒ©nh v·ª±c sang s·ªë qu·∫ßy
    const serviceToCounter = {
      "Ch·ª©ng th·ª±c - H·ªô t·ªãch": "1",
      "VƒÉn th∆∞": "2",
      "N·ªôi v·ª• - GDƒêT - VƒÉn h√≥a - Khoa h·ªçc v√† Th√¥ng tin - Y t·∫ø - Lao ƒë·ªông - B·∫£o tr·ª£ X√£ h·ªôi": "3",
      "N√¥ng nghi·ªáp v√† M√¥i tr∆∞·ªùng - T√†i ch√≠nh K·∫ø ho·∫°ch - X√¢y d·ª±ng v√† C√¥ng th∆∞∆°ng": "4"
    };

    // Bi·∫øn theo d√µi l·ªánh g·ªçi g·∫ßn nh·∫•t ƒë·ªÉ ph√°t √¢m thanh
    let lastKnownCalls = {};

    // H√†m ki·ªÉm tra v√† ph√°t √¢m thanh cho l·ªánh g·ªçi m·ªõi
    function checkForNewCalls() {
  fetch('https://hcctrile.onrender.com/latest-calls')
        .then(res => res.json())
        .then(latestCalls => {
          console.log('üì° Ki·ªÉm tra l·ªánh g·ªçi m·ªõi:', latestCalls);
          
          for (const service in latestCalls) {
            const latestCall = latestCalls[service];
            if (latestCall && latestCall.number) {
              const lastKnown = lastKnownCalls[service];
              
              console.log(`üîç Service: ${service}`);
              console.log(`   Latest call:`, latestCall);
              console.log(`   Last known:`, lastKnown);
              
              // Ki·ªÉm tra xem c√≥ l·ªánh g·ªçi m·ªõi kh√¥ng
              if (!lastKnown || 
                  lastKnown.number !== latestCall.number || 
                  lastKnown.time !== latestCall.time) {
                
                console.log(`üÜï Ph√°t hi·ªán l·ªánh g·ªçi m·ªõi cho ${service}!`);
                
                // Ph√°t √¢m thanh cho l·ªánh g·ªçi m·ªõi
                const counterNumber = serviceToCounter[service];
                if (counterNumber) {
                  console.log(`üîî Ph√°t th√¥ng b√°o cho l·ªánh g·ªçi m·ªõi: ${latestCall.number} - Qu·∫ßy ${counterNumber}${latestCall.isRecall ? ' (G·ªçi l·∫°i)' : ''}`);
                  announceNumber(latestCall.number, counterNumber, latestCall.isRecall || false);
                } else {
                  console.log(`‚ùå Kh√¥ng t√¨m th·∫•y counter number cho service: ${service}`);
                }
                
                // C·∫≠p nh·∫≠t theo d√µi
                lastKnownCalls[service] = {
                  number: latestCall.number,
                  time: latestCall.time
                };
              } else {
                console.log(`‚úÖ Kh√¥ng c√≥ l·ªánh g·ªçi m·ªõi cho ${service}`);
              }
            } else {
              console.log(`‚ö™ Kh√¥ng c√≥ l·ªánh g·ªçi n√†o cho ${service}`);
            }
          }
        })
        .catch(error => {
          console.error('‚ùå L·ªói khi ki·ªÉm tra l·ªánh g·ªçi m·ªõi:', error);
        });
    }

    function updateCurrentTime() {
      const now = new Date();
      
      // C·∫≠p nh·∫≠t gi·ªù
      const timeHour = now.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('timeHour').textContent = timeHour;
      
      // C·∫≠p nh·∫≠t ng√†y th√°ng nƒÉm
      const timeDate = now.toLocaleDateString('vi-VN', {
        weekday: 'long',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
      document.getElementById('timeDate').textContent = timeDate;
    }

    function formatTime(timeString) {
      const date = new Date(timeString);
      return date.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function formatDate(timeString) {
      const date = new Date(timeString);
      return date.toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function createCounterCard(counter) {
      const hasCurrentCall = counter.currentCalling !== null;
      const cardClass = hasCurrentCall ? 'counter-card active' : 'counter-card';
      
      return `
        <div class="${cardClass}" data-service="${counter.service}">
          <div class="counter-header">
            <div class="counter-number">QU·∫¶Y ${counter.counterNumber}</div>
          </div>
          
          <div class="current-calling">
            <div class="calling-label">ƒêang g·ªçi</div>
            <div class="calling-display">
              ${hasCurrentCall ? `
                <div class="calling-number">${counter.currentCalling.number}</div>
                <div class="calling-time">G·ªçi l√∫c: ${formatDate(counter.currentCalling.time)}</div>
              ` : `
                <div class="no-calling">Ch∆∞a c√≥</div>
              `}
            </div>
          </div>
          
          <div class="waiting-info">
            <span class="waiting-count">Kh√°ch ƒëang ch·ªù:</span>
            <span class="waiting-number">${counter.waitingCount}</span>
          </div>
        </div>
      `;
    }

    function updateCounterCard(card, counter) {
      const hasCurrentCall = counter.currentCalling !== null;
      const oldData = currentCountersData[counter.service];
      
      // Ki·ªÉm tra xem c√≥ s·ªë m·ªõi ƒë∆∞·ª£c g·ªçi kh√¥ng
      const isNewCall = hasCurrentCall && (!oldData || 
        !oldData.currentCalling || 
        oldData.currentCalling.number !== counter.currentCalling.number);
      
      // C·∫≠p nh·∫≠t class cho card
      if (hasCurrentCall && !card.classList.contains('active')) {
        card.classList.add('active');
      } else if (!hasCurrentCall && card.classList.contains('active')) {
        card.classList.remove('active');
      }
      
      // C·∫≠p nh·∫≠t n·ªôi dung calling display
      const callingDisplay = card.querySelector('.calling-display');
      const newCallingContent = hasCurrentCall ? `
        <div class="calling-number">${counter.currentCalling.number}</div>
        <div class="calling-time">G·ªçi l√∫c: ${formatDate(counter.currentCalling.time)}</div>
      ` : `
        <div class="no-calling">Ch∆∞a c√≥</div>
      `;
      
      if (callingDisplay.innerHTML.trim() !== newCallingContent.trim()) {
        callingDisplay.style.opacity = '0.5';
        setTimeout(() => {
          callingDisplay.innerHTML = newCallingContent;
          callingDisplay.style.opacity = '1';
        }, 150);
      }
      
      // C·∫≠p nh·∫≠t s·ªë kh√°ch ch·ªù
      const waitingNumber = card.querySelector('.waiting-number');
      if (waitingNumber.textContent !== counter.waitingCount.toString()) {
        waitingNumber.style.transform = 'scale(1.2)';
        waitingNumber.textContent = counter.waitingCount;
        
        // Animation cho s·ªë thay ƒë·ªïi
        waitingNumber.classList.add('highlight');
        setTimeout(() => {
          waitingNumber.style.transform = 'scale(1)';
          waitingNumber.classList.remove('highlight');
        }, 600);
      }
      
      // Hi·ªáu ·ª©ng cho cu·ªôc g·ªçi m·ªõi
      if (isNewCall) {
        console.log('üÜï S·ªë m·ªõi ƒë∆∞·ª£c g·ªçi:', counter.currentCalling.number, 't·∫°i qu·∫ßy', counter.counterNumber);
        
        // Ch√∫ √Ω: Kh√¥ng ph√°t th√¥ng b√°o ·ªü ƒë√¢y v√¨ ƒë√£ c√≥ checkForNewCalls() x·ª≠ l√Ω
        // announceNumber(counter.currentCalling.number, counter.counterNumber);
        
        // Animation cho card
        card.style.animation = 'newCall 2s ease-in-out';
        setTimeout(() => {
          card.style.animation = '';
        }, 2000);
        
        // Visual feedback
        const callingNumberElement = card.querySelector('.calling-number');
        if (callingNumberElement) {
          callingNumberElement.style.animation = 'pulse 1s ease-in-out 3';
          setTimeout(() => {
            callingNumberElement.style.animation = '';
          }, 3000);
        }
      }
    }

    async function loadCountersStatus() {
      try {
  const response = await fetch('https://hcctrile.onrender.com/all-counters-status');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üìä D·ªØ li·ªáu qu·∫ßy nh·∫≠n ƒë∆∞·ª£c:', data);
        
        const grid = document.getElementById('countersGrid');
        
        // X·ª≠ l√Ω d·ªØ li·ªáu cho t·ª´ng qu·∫ßy
        data.counters.forEach(counter => {
          let card = grid.querySelector(`[data-service="${counter.service}"]`);
          
          if (!card) {
            // T·∫°o card m·ªõi n·∫øu ch∆∞a c√≥
            grid.innerHTML += createCounterCard(counter);
            card = grid.querySelector(`[data-service="${counter.service}"]`);
            card.classList.add('refresh-animation');
          } else {
            // C·∫≠p nh·∫≠t card hi·ªán c√≥
            updateCounterCard(card, counter);
          }
        });
        
        // L∆∞u d·ªØ li·ªáu hi·ªán t·∫°i ƒë·ªÉ so s√°nh l·∫ßn sau
        currentCountersData = {};
        data.counters.forEach(counter => {
          currentCountersData[counter.service] = counter;
        });
        
        lastUpdateTime = Date.now();
        
      } catch (error) {
        console.error('‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu qu·∫ßy:', error);
        
        // Th·ª≠ l·∫°i sau 3 gi√¢y
        setTimeout(() => {
          loadCountersStatus();
        }, 3000);
      }
    }

    // Kh·ªüi t·∫°o
    function init() {
      console.log('üöÄ Kh·ªüi t·∫°o m√†n h√¨nh hi·ªÉn th·ªã t·∫•t c·∫£ qu·∫ßy');
      
      // C·∫≠p nh·∫≠t th·ªùi gian ngay l·∫≠p t·ª©c
      updateCurrentTime();
      
      // T·∫£i d·ªØ li·ªáu qu·∫ßy ngay l·∫≠p t·ª©c
      loadCountersStatus();
      
      // Thi·∫øt l·∫≠p c√°c interval
      setInterval(updateCurrentTime, 1000);
      setInterval(loadCountersStatus, 3000); // C·∫≠p nh·∫≠t m·ªói 3 gi√¢y
      setInterval(checkForNewCalls, 2000); // Ki·ªÉm tra l·ªánh g·ªçi m·ªõi m·ªói 2 gi√¢y
      
      console.log('‚úÖ Kh·ªüi t·∫°o ho√†n t·∫•t');
    }

    // Kh·ªüi t·∫°o khi trang web load xong
    document.addEventListener('DOMContentLoaded', init);

    // X·ª≠ l√Ω focus/blur ƒë·ªÉ t·ªëi ∆∞u hi·ªáu su·∫•t
    let isPageVisible = true;
    let refreshInterval;

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        isPageVisible = false;
        console.log('üì± Trang web b·ªã ·∫©n - Gi·∫£m t·∫ßn su·∫•t c·∫≠p nh·∫≠t');
        clearInterval(refreshInterval);
        refreshInterval = setInterval(loadCountersStatus, 10000); // 10 gi√¢y khi ·∫©n
      } else {
        isPageVisible = true;
        console.log('üì± Trang web ƒë∆∞·ª£c hi·ªÉn th·ªã - Kh√¥i ph·ª•c t·∫ßn su·∫•t c·∫≠p nh·∫≠t');
        clearInterval(refreshInterval);
        refreshInterval = setInterval(loadCountersStatus, 3000); // 3 gi√¢y khi hi·ªÉn th·ªã
        
        // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c khi c√≥ th√¥ng b√°o
        setTimeout(loadCountersStatus, 500);
      }
    });
  </script>
</body>
</html>
