<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Th√¥ng b√°o s·ªë th·ª© t·ª±</title>
  <style>
  body { 
    font-family: Arial, sans-serif; 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    margin: 0; 
    padding: 0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .container { 
    width: 90vw;
    max-width: 800px;
    background: white; 
    border-radius: 20px; 
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    overflow: hidden;
  }
  .header {
    background: linear-gradient(135deg, #1976d2, #42a5f5);
    color: white;
    padding: 20px;
    text-align: center;
  }
  .header h1 {
    margin: 0;
    font-size: 28px;
    font-weight: bold;
  }
  .header .time {
    margin-top: 10px;
    font-size: 16px;
    opacity: 0.9;
  }
  .current-call {
    padding: 40px 20px;
    text-align: center;
    background: #f8f9fa;
  }
  .current-call.active {
    background: linear-gradient(135deg, #4caf50, #81c784);
    color: white;
  }
  .current-call h2 {
    margin: 0 0 20px 0;
    font-size: 24px;
    color: #333;
  }
  .current-call.active h2 {
    color: white;
  }
  .number-display {
    font-size: 120px;
    font-weight: bold;
    margin: 20px 0;
    color: #1976d2;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
  }
  .current-call.active .number-display {
    color: white;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
  }
  .service-name {
    font-size: 32px;
    font-weight: bold;
    margin: 20px 0;
    color: #1976d2;
  }
  .current-call.active .service-name {
    color: white;
  }
  .call-time {
    font-size: 18px;
    color: #666;
    margin-top: 15px;
  }
  .current-call.active .call-time {
    color: #e8f5e9;
  }
  .recent-calls {
    padding: 30px;
  }
  .recent-calls h3 {
    margin: 0 0 20px 0;
    color: #333;
    font-size: 20px;
    text-align: center;
  }
  .calls-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }
  .call-item {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    border-left: 4px solid #1976d2;
  }
  .call-item .number {
    font-size: 24px;
    font-weight: bold;
    color: #1976d2;
    margin-bottom: 5px;
  }
  .call-item .service {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
  }
  .call-item .time {
    font-size: 12px;
    color: #999;
  }
  .no-calls {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 40px;
  }
  .status-bar {
    background: #333;
    color: white;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
  }
  .status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #4caf50;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
  }
  .refresh-animation {
    animation: fadeIn 0.5s ease-in-out;
  }
  @keyframes fadeIn {
    0% { opacity: 0; transform: translateY(20px); }
    100% { opacity: 1; transform: translateY(0); }
  }
  @media (max-width: 768px) {
    .container {
      width: 95vw;
      margin: 10px;
    }
    .number-display {
      font-size: 80px;
    }
    .service-name {
      font-size: 24px;
    }
    .calls-list {
      grid-template-columns: 1fr;
    }
  }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîî Th√¥ng b√°o s·ªë th·ª© t·ª±</h1>
      <div class="time" id="currentTime"></div>
    </div>

    <div class="current-call" id="currentCall">
      <h2>S·ªë th·ª© t·ª± hi·ªán t·∫°i</h2>
      <div class="number-display" id="currentNumber">---</div>
      <div class="service-name" id="currentService">Ch∆∞a c√≥ cu·ªôc g·ªçi</div>
      <div class="call-time" id="currentCallTime"></div>
    </div>

    <div class="recent-calls">
      <h3>üìã C√°c s·ªë ƒë√£ g·ªçi g·∫ßn ƒë√¢y</h3>
      <div class="calls-list" id="callsList">
        <div class="no-calls">Ch∆∞a c√≥ d·ªØ li·ªáu</div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-indicator">
        <div class="status-dot"></div>
        <span>ƒêang k·∫øt n·ªëi</span>
      </div>
      <div id="lastUpdate">C·∫≠p nh·∫≠t: --:--</div>
    </div>
  </div>

  <script>
    let latestCallTime = null;

    // H√†m ph√°t √¢m thanh ƒë∆°n gi·∫£n nh∆∞ ti·∫øng g√µ c·ª≠a
    function playKnockSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // T·∫°o 3 ti·∫øng "g√µ" li√™n ti·∫øp
        const times = [0, 0.15, 0.3];
        
        times.forEach(startTime => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          // T·∫ßn s·ªë th·∫•p gi·ªëng ti·∫øng g√µ c·ª≠a
          oscillator.frequency.setValueAtTime(150, audioContext.currentTime + startTime);
          oscillator.frequency.exponentialRampToValueAtTime(80, audioContext.currentTime + startTime + 0.1);
          
          // √Çm l∆∞·ª£ng nhanh l√™n r·ªìi nhanh xu·ªëng
          gainNode.gain.setValueAtTime(0, audioContext.currentTime + startTime);
          gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + startTime + 0.02);
          gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + startTime + 0.1);
          
          oscillator.start(audioContext.currentTime + startTime);
          oscillator.stop(audioContext.currentTime + startTime + 0.1);
        });
      } catch (error) {
        console.log('Kh√¥ng th·ªÉ ph√°t √¢m thanh:', error);
      }
    }

    // H√†m th√¥ng b√°o b·∫±ng gi·ªçng n√≥i ti·∫øng Vi·ªát Microsoft Mai
    function announceNumber(number, service) {
      try {
        // Ki·ªÉm tra xem c√≥ th√¥ng b√°o n√†o ƒëang ph√°t kh√¥ng
        if (speechSynthesis.speaking) {
          console.log('‚è∏Ô∏è ƒêang c√≥ th√¥ng b√°o kh√°c, b·ªè qua l·∫ßn n√†y');
          return;
        }
        
        // Mapping service to counter number
        const serviceToCounter = {
          "Ch·ª©ng th·ª±c H·ªô t·ªãch": "1",
          "VƒÉn th∆∞": "2",
          "N·ªôi v·ª• - GDƒêT - VƒÉn h√≥a - Khoa h·ªçc v√† Th√¥ng tin - Y t·∫ø - Lao ƒë·ªông - B·∫£o tr·ª£ X√£ h·ªôi": "3",
          "N√¥ng nghi·ªáp M√¥i tr∆∞·ªùng - T√†i ch√≠nh k·∫ø ho·∫°ch - X√¢y d·ª±ng v√† C√¥ng th∆∞∆°ng": "4"
        };
        
        const counterNumber = serviceToCounter[service] || "1";
        
        // T·∫°o c√¢u th√¥ng b√°o v·ªõi ng·∫Øt qu√£ng r√µ r√†ng
                const message = `Xin k√≠nh m·ªùi qu√Ω kh√°ch c√≥ s·ªë th·ª© t·ª±..... ${number}..... ƒê·∫øn qu·∫ßy s·ªë..... ${service.counter}...... ƒê·ªÉ th·ª±c hi·ªán th·ªß t·ª•c h√†nh ch√≠nh`;
        
        // S·ª≠ d·ª•ng Web Speech API v·ªõi gi·ªçng Microsoft Mai
        const utterance = new SpeechSynthesisUtterance(message);
        
        // ƒê·ª£i t·∫£i danh s√°ch gi·ªçng n√≥i v√† ch·ªçn Microsoft Mai
        if (speechSynthesis.getVoices().length === 0) {
          speechSynthesis.addEventListener('voiceschanged', () => {
            setVietnameseVoiceForNumberDisplay(utterance, message);
          }, { once: true });
        } else {
          setVietnameseVoiceForNumberDisplay(utterance, message);
        }
        
      } catch (error) {
        console.log('Kh√¥ng th·ªÉ ph√°t th√¥ng b√°o gi·ªçng n√≥i:', error);
        // Fallback v·ªÅ ti·∫øng g√µ c·ª≠a n·∫øu kh√¥ng th·ªÉ ph√°t gi·ªçng n√≥i
        playKnockSound();
      }
    }
    
    // H√†m h·ªó tr·ª£ thi·∫øt l·∫≠p gi·ªçng n√≥i ti·∫øng Vi·ªát (∆∞u ti√™n gi·ªçng n·ªØ) cho number display
    function setVietnameseVoiceForNumberDisplay(utterance, message) {
      // D·ª´ng t·∫•t c·∫£ gi·ªçng n√≥i tr∆∞·ªõc ƒë√≥ ngay l·∫≠p t·ª©c
      speechSynthesis.cancel();
      
      const voices = speechSynthesis.getVoices();
      console.log('Danh s√°ch t·∫•t c·∫£ gi·ªçng n√≥i c√≥ s·∫µn (Number Display):');
      voices.forEach((voice, index) => {
        const genderInfo = voice.name.toLowerCase().includes('female') || 
                          voice.name.toLowerCase().includes('woman') || 
                          voice.name.toLowerCase().includes('mai') || 
                          voice.name.toLowerCase().includes('linh') || 
                          voice.name.toLowerCase().includes('yen') || 
                          voice.name.toLowerCase().includes('h∆∞∆°ng') || 
                          voice.name.toLowerCase().includes('lan') ? 'Female' : 'Unknown';
        console.log(`${index}: ${voice.name} (${voice.lang}) - ${voice.localService ? 'Local' : 'Remote'} - Gender: ${genderInfo}`);
      });
      
      // L·ªçc ch·ªâ l·∫•y gi·ªçng n√≥i ti·∫øng Vi·ªát
      const vietnameseVoices = voices.filter(voice => 
        voice.lang === 'vi-VN' || 
        voice.lang === 'vi' || 
        voice.lang.toLowerCase().includes('vi-vn') ||
        voice.name.toLowerCase().includes('vietnam') ||
        voice.name.toLowerCase().includes('mai') ||
        voice.name.toLowerCase().includes('linh')
      );
      
      console.log('ÔøΩüá≥ Ch·ªâ gi·ªçng n√≥i ti·∫øng Vi·ªát (Number Display):', vietnameseVoices);
      
      // Th·ª≠ t√¨m gi·ªçng n·ªØ ti·∫øng Vi·ªát theo th·ª© t·ª± ∆∞u ti√™n (5 c·∫•p ƒë·ªô)
      let selectedVoice = null;
      
      // 1. ∆Øu ti√™n cao nh·∫•t: T√™n gi·ªçng n·ªØ Vi·ªát Nam c·ª• th·ªÉ
      selectedVoice = vietnameseVoices.find(voice => 
        voice.name.toLowerCase().includes('mai') ||
        voice.name.toLowerCase().includes('linh') ||
        voice.name.toLowerCase().includes('yen') ||
        voice.name.toLowerCase().includes('h∆∞∆°ng') ||
        voice.name.toLowerCase().includes('lan')
      );
      if (selectedVoice) {
        console.log('üéØ T√¨m th·∫•y gi·ªçng n·ªØ Vi·ªát Nam:', selectedVoice.name);
      }
      
      // 2. T√¨m gi·ªçng n·ªØ c√≥ ng√¥n ng·ªØ Vi·ªát Nam
      if (!selectedVoice) {
        selectedVoice = vietnameseVoices.find(voice => 
          voice.name.toLowerCase().includes('female') ||
          voice.name.toLowerCase().includes('woman')
        );
        if (selectedVoice) {
          console.log('üéØ T√¨m th·∫•y gi·ªçng n·ªØ ti·∫øng Vi·ªát:', selectedVoice.name);
        }
      }
      
      // 3. T√¨m B·∫§T K·ª≤ gi·ªçng ti·∫øng Vi·ªát n√†o
      if (!selectedVoice && vietnameseVoices.length > 0) {
        selectedVoice = vietnameseVoices[0];
        console.log('üéØ T√¨m th·∫•y gi·ªçng ti·∫øng Vi·ªát:', selectedVoice.name);
      }
      
      // QUAN TR·ªåNG: Ch·ªâ ti·∫øp t·ª•c n·∫øu c√≥ gi·ªçng ti·∫øng Vi·ªát
      if (!selectedVoice) {
        console.log('‚ùå KH√îNG T√åM TH·∫§Y GI·ªåNG TI·∫æNG VI·ªÜT - H·ª¶Y TH√îNG B√ÅO (Number Display)');
        return; // D·ª´ng l·∫°i n·∫øu kh√¥ng c√≥ gi·ªçng ti·∫øng Vi·ªát
      }
      
      // Thi·∫øt l·∫≠p gi·ªçng n√≥i
      utterance.voice = selectedVoice;
      console.log('‚úÖ ƒê√£ ch·ªçn gi·ªçng n√≥i ti·∫øng Vi·ªát:', selectedVoice.name, '(' + selectedVoice.lang + ')');
      
      // Force set ng√¥n ng·ªØ ti·∫øng Vi·ªát v√† lo·∫°i b·ªè m·ªçi kh·∫£ nƒÉng ti·∫øng Anh
      utterance.lang = 'vi-VN';
      
      // Thi·∫øt l·∫≠p c√°c tham s·ªë (ch·∫≠m h∆°n v√† cao h∆°n cho gi·ªçng n·ªØ)
      utterance.rate = 0.5; // T·ªëc ƒë·ªô n√≥i r·∫•t ch·∫≠m ƒë·ªÉ r√µ r√†ng h∆°n
      utterance.pitch = 1.1; // √Çm ƒëi·ªáu cao h∆°n cho gi·ªçng n·ªØ
      utterance.volume = 1.0; // √Çm l∆∞·ª£ng t·ªëi ƒëa
      
      // Th√™m event listeners ƒë·ªÉ debug
      utterance.onstart = () => console.log('üîä B·∫Øt ƒë·∫ßu ph√°t √¢m TI·∫æNG VI·ªÜT (Number Display)');
      utterance.onend = () => console.log('‚úÖ Ho√†n th√†nh ph√°t √¢m TI·∫æNG VI·ªÜT (Number Display)');
      utterance.onerror = (e) => console.log('‚ùå L·ªói ph√°t √¢m (Number Display):', e);
      
      // ƒê·∫¢M B·∫¢O CH·ªà PH√ÅT TI·∫æNG VI·ªÜT
      speechSynthesis.cancel(); // H·ªßy t·∫•t c·∫£ tr∆∞·ªõc ƒë√≥
      
      // Th√™m delay ƒë·ªÉ ƒë·∫£m b·∫£o voice selection ho√†n to√†n
      setTimeout(() => {
        // Ki·ªÉm tra l·∫ßn cu·ªëi tr∆∞·ªõc khi ph√°t
        if (utterance.voice && utterance.voice.lang.includes('vi')) {
          console.log('üéØ Number Display: X√ÅC NH·∫¨N S·∫Ω ph√°t gi·ªçng', utterance.voice.name, utterance.voice.lang);
          speechSynthesis.speak(utterance);
        } else {
          console.log('‚ùå Number Display: KH√îNG AN TO√ÄN - H·ªßy v√¨ kh√¥ng ph·∫£i ti·∫øng Vi·ªát');
        }
      }, 200); // TƒÉng delay l√™n 200ms
      
      console.log('üì¢ ƒê√£ g·ª≠i l·ªánh ph√°t th√¥ng b√°o (Number Display) v·ªõi gi·ªçng ti·∫øng Vi·ªát:', selectedVoice.name);
    }

    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleString('vi-VN', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('currentTime').textContent = timeString;
    }

    function formatTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleTimeString('vi-VN', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    function formatDateTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    async function loadLatestCalls() {
      try {
        const response = await fetch('https://layso.onrender.com/latest-call');
        const data = await response.json();
        
        if (data.success && data.calls.length > 0) {
          const calls = data.calls;
          const latestCall = calls[0];
          
          // C·∫≠p nh·∫≠t s·ªë hi·ªán t·∫°i
          const currentCallDiv = document.getElementById('currentCall');
          document.getElementById('currentNumber').textContent = latestCall.number;
          document.getElementById('currentService').textContent = latestCall.service;
          document.getElementById('currentCallTime').textContent = `G·ªçi l√∫c: ${formatTime(latestCall.time)}`;
          
          // Ki·ªÉm tra xem c√≥ cu·ªôc g·ªçi m·ªõi kh√¥ng
          if (latestCallTime !== latestCall.time) {
            latestCallTime = latestCall.time;
            
            // T·∫ÆT √ÇM THANH CHO NUMBER DISPLAY - Ch·ªâ hi·ªÉn th·ªã visual
            console.log('üì∫ Number Display: Ch·ªâ hi·ªÉn th·ªã th√¥ng tin, kh√¥ng ph√°t √¢m thanh');
            // announceNumber(latestCall.number, latestCall.service); // ƒê√É T·∫ÆT
            
            // Th√™m hi·ªáu ·ª©ng cho cu·ªôc g·ªçi m·ªõi
            currentCallDiv.classList.add('active', 'refresh-animation');
            
            setTimeout(() => {
              currentCallDiv.classList.remove('refresh-animation');
            }, 500);
          }
          
          // C·∫≠p nh·∫≠t danh s√°ch c√°c cu·ªôc g·ªçi g·∫ßn ƒë√¢y
          updateRecentCalls(calls.slice(1)); // B·ªè cu·ªôc g·ªçi ƒë·∫ßu ti√™n (ƒë√£ hi·ªÉn th·ªã ·ªü tr√™n)
          
        } else {
          // Kh√¥ng c√≥ cu·ªôc g·ªçi n√†o
          document.getElementById('currentNumber').textContent = '---';
          document.getElementById('currentService').textContent = 'Ch∆∞a c√≥ cu·ªôc g·ªçi';
          document.getElementById('currentCallTime').textContent = '';
          document.getElementById('currentCall').classList.remove('active');
          
          document.getElementById('callsList').innerHTML = '<div class="no-calls">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
        }
        
        // C·∫≠p nh·∫≠t th·ªùi gian last update
        document.getElementById('lastUpdate').textContent = `C·∫≠p nh·∫≠t: ${formatTime(new Date())}`;
        
      } catch (error) {
        console.error('Error loading latest calls:', error);
        document.getElementById('callsList').innerHTML = '<div class="no-calls">L·ªói k·∫øt n·ªëi</div>';
      }
    }

    function updateRecentCalls(calls) {
      const callsList = document.getElementById('callsList');
      
      if (calls.length === 0) {
        callsList.innerHTML = '<div class="no-calls">Kh√¥ng c√≥ cu·ªôc g·ªçi g·∫ßn ƒë√¢y</div>';
        return;
      }
      
      callsList.innerHTML = calls.map(call => `
        <div class="call-item">
          <div class="number">${call.number}</div>
          <div class="service">${call.service}</div>
          <div class="time">${formatDateTime(call.time)}</div>
        </div>
      `).join('');
    }

    // Kh·ªüi t·∫°o
    updateCurrentTime();
    loadLatestCalls();

    // C·∫≠p nh·∫≠t th·ªùi gian m·ªói gi√¢y
    setInterval(updateCurrentTime, 1000);

    // C·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªói 10 gi√¢y (tƒÉng t·ª´ 2 gi√¢y)
    setInterval(loadLatestCalls, 10000);

    // X·ª≠ l√Ω window message cho popup
    window.addEventListener("message", (event) => {
      if (event.data && event.data.type === 'NEW_CALL') {
        const { number, service } = event.data;
        
        // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
        document.getElementById('currentNumber').textContent = number;
        document.getElementById('currentService').textContent = service;
        document.getElementById('currentCallTime').textContent = `G·ªçi l√∫c: ${formatTime(new Date())}`;
        
        const currentCallDiv = document.getElementById('currentCall');
        currentCallDiv.classList.add('active', 'refresh-animation');
        
        setTimeout(() => {
          currentCallDiv.classList.remove('refresh-animation');
        }, 500);
        
        // T·∫£i l·∫°i d·ªØ li·ªáu sau 1 gi√¢y
        setTimeout(loadLatestCalls, 1000);
      }
    });
  </script>
</body>
</html>
